"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const pinkie_1 = __importDefault(require("pinkie"));
const browserstack_local_1 = require("browserstack-local");
const os_family_1 = __importDefault(require("os-family"));
const url_1 = __importDefault(require("url"));
const tmp_1 = __importDefault(require("tmp"));
const PROXY_AUTH_RE = /^([^:]*)(?::(.*))?$/;
const identity = x => x;
const capitalize = str => str[0].toUpperCase() + str.slice(1);
function copyOptions(source, destination, transfromFunc = identity) {
    Object
        .keys(source)
        .forEach(key => source[key] && (destination[transfromFunc(key)] = source[key]));
}
function getProxyOptions(proxyConfig) {
    try {
        var { hostname, port, auth } = url_1.default.parse('http://' + proxyConfig);
        var parsedAuth = auth && auth.match(PROXY_AUTH_RE);
        return {
            host: hostname === 'undefined' ? null : hostname,
            port: port,
            user: parsedAuth && parsedAuth[1],
            pass: parsedAuth && parsedAuth[2]
        };
    }
    catch (e) {
        return {};
    }
}
class BrowserstackConnector {
    constructor(accessKey) {
        this.accessKey = accessKey;
        this.connectorInstance = null;
        this.tempFileName = '';
    }
    _getTempFileName() {
        if (!this.tempFileName) {
            tmp_1.default.setGracefulCleanup();
            this.tempFileName = tmp_1.default.tmpNameSync({ unsafeCleanup: true });
        }
        return this.tempFileName;
    }
    create() {
        return new pinkie_1.default((resolve, reject) => {
            var connector = new browserstack_local_1.Local();
            var parallelRuns = process.env['BROWSERSTACK_PARALLEL_RUNS'];
            var logfile = process.env['BROWSERSTACK_LOGFILE'] || (os_family_1.default.win ? this._getTempFileName() : '/dev/null');
            var verbose = process.env['BROWSERSTACK_VERBOSE'];
            var binarypath = process.env['BROWSERSTACK_BINARY_PATH'];
            var opts = Object.assign(Object.assign(Object.assign(Object.assign({ key: this.accessKey, logfile, forceLocal: !!process.env['BROWSERSTACK_FORCE_LOCAL'], forceProxy: !!process.env['BROWSERSTACK_FORCE_PROXY'], localIdentifier: Date.now() }, parallelRuns ? { parallelRuns } : {}), verbose ? { verbose } : {}), binarypath ? { binarypath } : {}), { 
                //NOTE: additional args use different format
                'enable-logging-for-api': true });
            var proxyOptions = getProxyOptions(process.env['BROWSERSTACK_PROXY']);
            var localProxyOptions = getProxyOptions(process.env['BROWSERSTACK_LOCAL_PROXY']);
            copyOptions(proxyOptions, opts, key => 'proxy' + capitalize(key));
            copyOptions(localProxyOptions, opts, key => 'local-proxy-' + key);
            connector.start(opts, err => {
                if (err) {
                    reject(err);
                    return;
                }
                this.connectorInstance = connector;
                resolve(connector);
            });
        });
    }
    destroy() {
        return new pinkie_1.default((resolve, reject) => {
            this.connectorInstance.stop(err => {
                if (err) {
                    reject(err);
                    return;
                }
                resolve();
            });
        });
    }
}
exports.default = BrowserstackConnector;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29ubmVjdG9yLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL2Nvbm5lY3Rvci5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUFBLG9EQUE2QjtBQUM3QiwyREFBZ0U7QUFDaEUsMERBQTJCO0FBQzNCLDhDQUEwQjtBQUMxQiw4Q0FBc0I7QUFHdEIsTUFBTSxhQUFhLEdBQUcscUJBQXFCLENBQUM7QUFFNUMsTUFBTSxRQUFRLEdBQUcsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7QUFFeEIsTUFBTSxVQUFVLEdBQUcsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsV0FBVyxFQUFFLEdBQUcsR0FBRyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQztBQUU5RCxTQUFTLFdBQVcsQ0FBRSxNQUFNLEVBQUUsV0FBVyxFQUFFLGFBQWEsR0FBRyxRQUFRO0lBQy9ELE1BQU07U0FDRCxJQUFJLENBQUMsTUFBTSxDQUFDO1NBQ1osT0FBTyxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLGFBQWEsQ0FBQyxHQUFHLENBQUMsQ0FBQyxHQUFHLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7QUFDeEYsQ0FBQztBQUVELFNBQVMsZUFBZSxDQUFFLFdBQVc7SUFDakMsSUFBSTtRQUNBLElBQUksRUFBRSxRQUFRLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxHQUFHLGFBQU8sQ0FBQyxLQUFLLENBQUMsU0FBUyxHQUFHLFdBQVcsQ0FBQyxDQUFDO1FBQ3RFLElBQUksVUFBVSxHQUFpQixJQUFJLElBQUksSUFBSSxDQUFDLEtBQUssQ0FBQyxhQUFhLENBQUMsQ0FBQztRQUVqRSxPQUFPO1lBQ0gsSUFBSSxFQUFFLFFBQVEsS0FBSyxXQUFXLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsUUFBUTtZ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QUFJLEdBQUcsRUFBRTtvQkFDTCxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUM7b0JBQ1osT0FBTztpQkFDVjtnQkFFRCxJQUFJLENBQUMsaUJBQWlCLEdBQUcsU0FBUyxDQUFDO2dCQUNuQyxPQUFPLENBQUMsU0FBUyxDQUFDLENBQUM7WUFDdkIsQ0FBQyxDQUFDLENBQUM7UUFDUCxDQUFDLENBQUMsQ0FBQztJQUNQLENBQUM7SUFFRCxPQUFPO1FBQ0gsT0FBTyxJQUFJLGdCQUFPLENBQUMsQ0FBQyxPQUFPLEVBQUUsTUFBTSxFQUFFLEVBQUU7WUFDbkMsSUFBSSxDQUFDLGlCQUFpQixDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRTtnQkFDOUIsSUFBSSxHQUFHLEVBQUU7b0JBQ0wsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDO29CQUNaLE9BQU87aUJBQ1Y7Z0JBRUQsT0FBTyxFQUFFLENBQUM7WUFDZCxDQUFDLENBQUMsQ0FBQztRQUNQLENBQUMsQ0FBQyxDQUFDO0lBQ1AsQ0FBQztDQUNKO0FBdEVELHdDQXNFQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBQcm9taXNlIGZyb20gJ3BpbmtpZSc7XHJcbmltcG9ydCB7IExvY2FsIGFzIEJyb3dzZXJzdGFja0xvY2FsIH0gZnJvbSAnYnJvd3NlcnN0YWNrLWxvY2FsJztcclxuaW1wb3J0IE9TIGZyb20gJ29zLWZhbWlseSc7XHJcbmltcG9ydCBub2RlVXJsIGZyb20gJ3VybCc7XHJcbmltcG9ydCB0bXAgZnJvbSAndG1wJztcclxuXHJcblxyXG5jb25zdCBQUk9YWV9BVVRIX1JFID0gL14oW146XSopKD86OiguKikpPyQvO1xyXG5cclxuY29uc3QgaWRlbnRpdHkgPSB4ID0+IHg7XHJcblxyXG5jb25zdCBjYXBpdGFsaXplID0gc3RyID0+IHN0clswXS50b1VwcGVyQ2FzZSgpICsgc3RyLnNsaWNlKDEpO1xyXG5cclxuZnVuY3Rpb24gY29weU9wdGlvbnMgKHNvdXJjZSwgZGVzdGluYXRpb24sIHRyYW5zZnJvbUZ1bmMgPSBpZGVudGl0eSkge1xyXG4gICAgT2JqZWN0XHJcbiAgICAgICAgLmtleXMoc291cmNlKVxyXG4gICAgICAgIC5mb3JFYWNoKGtleSA9PiBzb3VyY2Vba2V5XSAmJiAoZGVzdGluYXRpb25bdHJhbnNmcm9tRnVuYyhrZXkpXSA9IHNvdXJjZVtrZXldKSk7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGdldFByb3h5T3B0aW9ucyAocHJveHlDb25maWcpIHtcclxuICAgIHRyeSB7XHJcbiAgICAgICAgdmFyIHsgaG9zdG5hbWUsIHBvcnQsIGF1dGggfSA9IG5vZGVVcmwucGFyc2UoJ2h0dHA6Ly8nICsgcHJveHlDb25maWcpO1xyXG4gICAgICAgIHZhciBwYXJzZWRBdXRoICAgICAgICAgICAgICAgPSBhdXRoICYmIGF1dGgubWF0Y2goUFJPWFlfQVVUSF9SRSk7XHJcblxyXG4gICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgIGhvc3Q6IGhvc3RuYW1lID09PSAndW5kZWZpbmVkJyA/IG51bGwgOiBob3N0bmFtZSxcclxuICAgICAgICAgICAgcG9ydDogcG9ydCxcclxuICAgICAgICAgICAgdXNlcjogcGFyc2VkQXV0aCAmJiBwYXJzZWRBdXRoWzFdLFxyXG4gICAgICAgICAgICBwYXNzOiBwYXJzZWRBdXRoICYmIHBhcnNlZEF1dGhbMl1cclxuICAgICAgICB9O1xyXG4gICAgfVxyXG4gICAgY2F0Y2ggKGUpIHtcclxuICAgICAgICByZXR1cm4ge307XHJcbiAgICB9XHJcbn1cclxuXHJcblxyXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBCcm93c2Vyc3RhY2tDb25uZWN0b3Ige1xyXG4gICAgY29uc3RydWN0b3IgKGFjY2Vzc0tleSkge1xyXG4gICAgICAgIHRoaXMuYWNjZXNzS2V5ICAgICAgICAgPSBhY2Nlc3NLZXk7XHJcbiAgICAgICAgdGhpcy5jb25uZWN0b3JJbnN0YW5jZSA9IG51bGw7XHJcbiAgICAgICAgdGhpcy50ZW1wRmlsZU5hbWUgICAgICA9ICcnO1xyXG4gICAgfVxyXG5cclxuICAgIF9nZXRUZW1wRmlsZU5hbWUgKCkge1xyXG4gICAgICAgIGlmICghdGhpcy50ZW1wRmlsZU5hbWUpIHtcclxuICAgICAgICAgICAgdG1wLnNldEdyYWNlZnVsQ2xlYW51cCgpO1xyXG5cclxuICAgICAgICAgICAgdGhpcy50ZW1wRmlsZU5hbWUgPSB0bXAudG1wTmFtZVN5bmMoeyB1bnNhZmVDbGVhbnVwOiB0cnVlIH0pO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcmV0dXJuIHRoaXMudGVtcEZpbGVOYW1lO1xyXG4gICAgfVxyXG5cclxuICAgIGNyZWF0ZSAoKSB7XHJcbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcclxuICAgICAgICAgICAgdmFyIGNvbm5lY3RvciAgICA9IG5ldyBCcm93c2Vyc3RhY2tMb2NhbCgpO1xyXG4gICAgICAgICAgICB2YXIgcGFyYWxsZWxSdW5zID0gcHJvY2Vzcy5lbnZbJ0JST1dTRVJTVEFDS19QQVJBTExFTF9SVU5TJ107XHJcbiAgICAgICAgICAgIHZhciBsb2dmaWxlID0gcHJvY2Vzcy5lbnZbJ0JST1dTRVJTVEFDS19MT0dGSUxFJ10gfHwgKE9TLndpbiA/IHRoaXMuX2dldFRlbXBGaWxlTmFtZSgpIDogJy9kZXYvbnVsbCcpO1xyXG4gICAgICAgICAgICB2YXIgdmVyYm9zZSA9IHByb2Nlc3MuZW52WydCUk9XU0VSU1RBQ0tfVkVSQk9TRSddO1xyXG4gICAgICAgICAgICB2YXIgYmluYXJ5cGF0aCA9IHByb2Nlc3MuZW52WydCUk9XU0VSU1RBQ0tfQklOQVJZX1BBVEgnXTtcclxuXHJcbiAgICAgICAgICAgIHZhciBvcHRzID0ge1xyXG4gICAgICAgICAgICAgICAga2V5OiAgICAgICAgICAgICB0aGlzLmFjY2Vzc0tleSxcclxuICAgICAgICAgICAgICAgIGxvZ2ZpbGUsXHJcbiAgICAgICAgICAgICAgICBmb3JjZUxvY2FsOiAgICAgICEhcHJvY2Vzcy5lbnZbJ0JST1dTRVJTVEFDS19GT1JDRV9MT0NBTCddLFxyXG4gICAgICAgICAgICAgICAgZm9yY2VQcm94eTogICAgICAhIXByb2Nlc3MuZW52WydCUk9XU0VSU1RBQ0tfRk9SQ0VfUFJPWFknXSxcclxuICAgICAgICAgICAgICAgIGxvY2FsSWRlbnRpZmllcjogRGF0ZS5ub3coKSxcclxuXHJcbiAgICAgICAgICAgICAgICAuLi5wYXJhbGxlbFJ1bnMgPyB7IHBhcmFsbGVsUnVucyB9IDoge30sXHJcbiAgICAgICAgICAgICAgICAuLi52ZXJib3NlID8geyB2ZXJib3NlIH0gOiB7fSxcclxuICAgICAgICAgICAgICAgIC4uLmJpbmFyeXBhdGggPyB7IGJpbmFyeXBhdGggfSA6IHt9LFxyXG5cclxuICAgICAgICAgICAgICAgIC8vTk9URTogYWRkaXRpb25hbCBhcmdzIHVzZSBkaWZmZXJlbnQgZm9ybWF0XHJcbiAgICAgICAgICAgICAgICAnZW5hYmxlLWxvZ2dpbmctZm9yLWFwaSc6IHRydWVcclxuICAgICAgICAgICAgfTtcclxuXHJcbiAgICAgICAgICAgIHZhciBwcm94eU9wdGlvbnMgICAgICA9IGdldFByb3h5T3B0aW9ucyhwcm9jZXNzLmVudlsnQlJPV1NFUlNUQUNLX1BST1hZJ10pO1xyXG4gICAgICAgICAgICB2YXIgbG9jYWxQcm94eU9wdGlvbnMgPSBnZXRQcm94eU9wdGlvbnMocHJvY2Vzcy5lbnZbJ0JST1dTRVJTVEFDS19MT0NBTF9QUk9YWSddKTtcclxuXHJcbiAgICAgICAgICAgIGNvcHlPcHRpb25zKHByb3h5T3B0aW9ucywgb3B0cywga2V5ID0+ICdwcm94eScgKyBjYXBpdGFsaXplKGtleSkpO1xyXG4gICAgICAgICAgICBjb3B5T3B0aW9ucyhsb2NhbFByb3h5T3B0aW9ucywgb3B0cywga2V5ID0+ICdsb2NhbC1wcm94eS0nICsga2V5KTtcclxuXHJcbiAgICAgICAgICAgIGNvbm5lY3Rvci5zdGFydChvcHRzLCBlcnIgPT4ge1xyXG4gICAgICAgICAgICAgICAgaWYgKGVycikge1xyXG4gICAgICAgICAgICAgICAgICAgIHJlamVjdChlcnIpO1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICB0aGlzLmNvbm5lY3Rvckluc3RhbmNlID0gY29ubmVjdG9yO1xyXG4gICAgICAgICAgICAgICAgcmVzb2x2ZShjb25uZWN0b3IpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICBkZXN0cm95ICgpIHtcclxuICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xyXG4gICAgICAgICAgICB0aGlzLmNvbm5lY3Rvckluc3RhbmNlLnN0b3AoZXJyID0+IHtcclxuICAgICAgICAgICAgICAgIGlmIChlcnIpIHtcclxuICAgICAgICAgICAgICAgICAgICByZWplY3QoZXJyKTtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgcmVzb2x2ZSgpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxufVxyXG4iXX0=