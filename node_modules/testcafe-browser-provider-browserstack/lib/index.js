"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const url_1 = require("url");
const pinkie_1 = __importDefault(require("pinkie"));
const util_1 = require("util");
const desired_capabilities_1 = __importDefault(require("desired-capabilities"));
const lodash_1 = require("lodash");
const connector_1 = __importDefault(require("./connector"));
const js_testing_1 = __importDefault(require("./backends/js-testing"));
const automate_1 = __importDefault(require("./backends/automate"));
const browser_proxy_1 = __importDefault(require("./browser-proxy"));
const is_env_var_true_1 = __importDefault(require("./utils/is-env-var-true"));
const mime_db_1 = __importDefault(require("mime-db"));
const ANDROID_PROXY_RESPONSE_DELAY = 500;
const isAutomateEnabled = () => is_env_var_true_1.default('BROWSERSTACK_USE_AUTOMATE');
const isLocalEnabled = () => !!process.env.BROWSERSTACK_LOCAL_IDENTIFIER || !is_env_var_true_1.default('BROWSERSTACK_NO_LOCAL');
function getMimeTypes() {
    const mimeTypes = Object.keys(mime_db_1.default);
    return mimeTypes.filter(mimeType => {
        const { extensions } = mime_db_1.default[mimeType];
        return extensions && extensions.length;
    }).join(',');
}
module.exports = {
    // Multiple browsers support
    isMultiBrowser: true,
    backend: null,
    connectorPromise: pinkie_1.default.resolve(null),
    browserProxyPromise: pinkie_1.default.resolve(null),
    workers: {},
    platformsInfo: [],
    browserNames: [],
    _createConnector() {
        this.connectorPromise = this.connectorPromise
            .then(async (connector) => {
            if (!connector) {
                connector = new connector_1.default(process.env['BROWSERSTACK_ACCESS_KEY']);
                await connector.create();
            }
            return connector;
        });
        return this.connectorPromise;
    },
    _disposeConnector() {
        this.connectorPromise = this.connectorPromise
            .then(async (connector) => {
            if (connector)
                await connector.destroy();
            return null;
        });
        return this.connectorPromise;
    },
    _getBrowserProxy(host, port) {
        this.browserProxyPromise = this.browserProxyPromise
            .then(async (browserProxy) => {
            if (!browserProxy) {
                browserProxy = new browser_proxy_1.default(host, port, { responseDelay: ANDROID_PROXY_RESPONSE_DELAY });
                await browserProxy.init();
            }
            return browserProxy;
        });
        return this.browserProxyPromise;
    },
    _disposeBrowserProxy() {
        this.browserProxyPromise = this.browserProxyPromise
            .then(async (browserProxy) => {
            if (browserProxy)
                await browserProxy.dispose();
            return null;
        });
        return this.browserProxyPromise;
    },
    async _getDeviceList() {
        this.platformsInfo = await this.backend.getBrowsersList();
    },
    _createQuery(capabilities) {
        var { browserName, browserVersion, platform } = desired_capabilities_1.default(capabilities)[0];
        browserName = browserName.toLowerCase();
        if (browserName === 'internet explorer')
            browserName = 'ie';
        return {
            name: browserName,
            version: browserVersion.toLowerCase(),
            platform: platform.toLowerCase()
        };
    },
    _generateBasicCapabilities(browserName) {
        return this._filterPlatformInfo(this._createQuery(browserName))[0];
    },
    _getCapabilitiesFromEnvironment() {
        // NOTE: This function maps env vars to browserstack capabilities.
        // For the full list of capabilities, see https://www.browserstack.com/automate/capabilities
        return {
            'build': process.env['BROWSERSTACK_BUILD_ID'],
            'project': process.env['BROWSERSTACK_PROJECT_NAME'],
            'resolution': process.env['BROWSERSTACK_DISPLAY_RESOLUTION'],
            'name': process.env['BROWSERSTACK_TEST_RUN_NAME'],
            'browserstack.debug': process.env['BROWSERSTACK_DEBUG'],
            'browserstack.console': process.env['BROWSERSTACK_CONSOLE'],
            'browserstack.networkLogs': process.env['BROWSERSTACK_NETWORK_LOGS'],
            'browserstack.video': process.env['BROWSERSTACK_VIDEO'],
            'browserstack.timezone': process.env['BROWSERSTACK_TIMEZONE'],
            'browserstack.geoLocation': process.env['BROWSERSTACK_GEO_LOCATION'],
            'browserstack.customNetwork': process.env['BROWSERSTACK_CUSTOM_NETWORK'],
            'browserstack.networkProfile': process.env['BROWSERSTACK_NETWORK_PROFILE'],
            'acceptSslCerts': process.env['BROWSERSTACK_ACCEPT_SSL_CERTS']
        };
    },
    _getCapabilitiesFromConfig() {
        const configPath = process.env.BROWSERSTACK_CAPABILITIES_CONFIG_PATH;
        if (!configPath)
            return {};
        return require(configPath);
    },
    _getAdditionalCapabilities() {
        const capabilitiesFromEnvironment = lodash_1.pickBy(this._getCapabilitiesFromEnvironment(), value => value !== void 0);
        return Object.assign(Object.assign({}, this._getCapabilitiesFromConfig()), capabilitiesFromEnvironment);
    },
    _filterPlatformInfo(query) {
        return this.platformsInfo
            .filter(info => {
            var browserNameMatched = info['browser'] && info['browser'].toLowerCase() === query.name;
            var deviceNameMatched = info['device'] && info['device'].toLowerCase() === query.name;
            var browserVersionMatched = info['browser_version'] && Number(info['browser_version']) === Number(query.version);
            var platformVersionMatched = info['os_version'] && Number(info['os_version']) === Number(query.version);
            var platformNameMatched = info['os'].toLowerCase() === query.platform ||
                `${info['os'].toLowerCase()} ${info['os_version'].toLowerCase()}` === query.platform;
            var isAnyVersion = query.version === 'any';
            var isAnyPlatform = query.platform === 'any';
            var desktopBrowserMatched = browserNameMatched &&
                (browserVersionMatched || isAnyVersion) &&
                (platformNameMatched || isAnyPlatform);
            var mobileBrowserMatched = deviceNameMatched &&
                (platformVersionMatched || isAnyVersion);
            return desktopBrowserMatched || mobileBrowserMatched;
        });
    },
    _generateBrowserNames() {
        this.browserNames = this.platformsInfo
            .map(info => {
            var isDesktop = !info['device'];
            var name = isDesktop ? info['browser'] : info['device'];
            var version = isDesktop ? info['browser_version'] : info['os_version'];
            var platform = isDesktop ? `${info['os']} ${info['os_version']}` : '';
            return `${name}@${version}${platform ? ':' + platform : ''}`;
        });
    },
    _prepareChromeCapabilities(capabilities) {
        if (process.env['BROWSERSTACK_CHROME_ARGS'] && process.env['BROWSERSTACK_CHROME_ARGS'].length > 0)
            capabilities.chromeOptions = { args: [process.env['BROWSERSTACK_CHROME_ARGS']] };
    },
    async _prepareFirefoxCapabilities(capabilities) {
        if (!process.env['BROWSERSTACK_USE_AUTOMATE'])
            return;
        const FirefoxProfile = require('firefox-profile');
        const profile = new FirefoxProfile();
        profile.defaultPreferences = {};
        profile.setPreference('browser.helperApps.neverAsk.saveToDisk', getMimeTypes());
        profile.updatePreferences();
        capabilities['firefox_profile'] = await util_1.promisify(profile.encoded).bind(profile)();
    },
    async _encodeFirefoxProfile(profile) {
        return new pinkie_1.default((resolve, reject) => {
            profile.encoded(function (err, encodedProfile) {
                if (err)
                    reject(err);
                else
                    resolve(encodedProfile);
            });
        });
    },
    // Required - must be implemented
    // Browser control
    async openBrowser(id, pageUrl, browserName) {
        const capabilities = Object.assign(Object.assign({}, this._generateBasicCapabilities(browserName)), this._getAdditionalCapabilities());
        capabilities.local = isLocalEnabled();
        // Give preference to the already running local identifier
        capabilities.localIdentifier = process.env.BROWSERSTACK_LOCAL_IDENTIFIER;
        if (capabilities.local && !capabilities.localIdentifier) {
            const connector = await this._createConnector();
            capabilities.localIdentifier = connector.connectorInstance.localIdentifierFlag;
        }
        if (capabilities.os.toLowerCase() === 'android') {
            const parsedPageUrl = url_1.parse(pageUrl);
            const browserProxy = await this._getBrowserProxy(parsedPageUrl.hostname, parsedPageUrl.port);
            pageUrl = 'http://' + browserProxy.targetHost + ':' + browserProxy.proxyPort + parsedPageUrl.path;
        }
        if (!capabilities.name)
            capabilities.name = `TestCafe test run ${id}`;
        if (browserName.includes('chrome'))
            this._prepareChromeCapabilities(capabilities);
        if (browserName.includes('firefox'))
            await this._prepareFirefoxCapabilities(capabilities);
        await this.backend.openBrowser(id, pageUrl, capabilities);
        this.setUserAgentMetaInfo(id, this.backend.getSessionUrl(id));
    },
    async closeBrowser(id) {
        await this.backend.closeBrowser(id);
    },
    // Optional - implement methods you need, remove other methods
    // Initialization
    async init() {
        var reportWarning = (...args) => this.reportWarning(...args);
        this.backend = isAutomateEnabled() ? new automate_1.default(reportWarning) : new js_testing_1.default(reportWarning);
        await this._getDeviceList();
        this._generateBrowserNames();
    },
    async dispose() {
        await this._disposeConnector();
        await this._disposeBrowserProxy();
    },
    // Browser names handling
    async getBrowserList() {
        return this.browserNames;
    },
    async isValidBrowserName(browserName) {
        return desired_capabilities_1.default(browserName).length === 1 && !!this._filterPlatformInfo(this._createQuery(browserName)).length;
    },
    // Extra methods
    async resizeWindow(id, width, height, currentWidth, currentHeight) {
        await this.backend.resizeWindow(id, width, height, currentWidth, currentHeight);
    },
    async maximizeWindow(id) {
        await this.backend.maximizeWindow(id);
    },
    async takeScreenshot(id, screenshotPath) {
        await this.backend.takeScreenshot(id, screenshotPath);
    },
    async reportJobResult(id, jobResult, jobData) {
        await this.backend.reportJobResult(id, jobResult, jobData, this.JOB_RESULT);
    }
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvaW5kZXguanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQSw2QkFBd0M7QUFDeEMsb0RBQTZCO0FBQzdCLCtCQUFpQztBQUNqQyxnRkFBcUQ7QUFDckQsbUNBQWdDO0FBQ2hDLDREQUFnRDtBQUNoRCx1RUFBcUQ7QUFDckQsbUVBQWtEO0FBQ2xELG9FQUEyQztBQUMzQyw4RUFBbUQ7QUFDbkQsc0RBQXlCO0FBRXpCLE1BQU0sNEJBQTRCLEdBQUcsR0FBRyxDQUFDO0FBRXpDLE1BQU0saUJBQWlCLEdBQUcsR0FBRyxFQUFFLENBQUMseUJBQVksQ0FBQywyQkFBMkIsQ0FBQyxDQUFDO0FBQzFFLE1BQU0sY0FBYyxHQUFNLEdBQUcsRUFBRSxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLDZCQUE2QixJQUFJLENBQUMseUJBQVksQ0FBQyx1QkFBdUIsQ0FBQyxDQUFDO0FBRXRILFNBQVMsWUFBWTtJQUNqQixNQUFNLFNBQVMsR0FBRyxNQUFNLENBQUMsSUFBSSxDQUFDLGlCQUFFLENBQUMsQ0FBQztJQUVsQyxPQUFPLFNBQVMsQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDLEVBQUU7UUFDL0IsTUFBTSxFQUFFLFVBQVUsRUFBRSxHQUFHLGlCQUFFLENBQUMsUUFBUSxDQUFDLENBQUM7UUFFcEMsT0FBTyxVQUFVLElBQUksVUFBVSxDQUFDLE1BQU0sQ0FBQztJQUMzQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7QUFDakIsQ0FBQztBQUVELE1BQU0sQ0FBQyxPQUFPLEdBQUc7SUFDYiw0QkFBNEI7SUFDNUIsY0FBYyxFQUFFLElBQUk7SUFFcEIsT0FBTyxFQUFFLElBQUk7SUFFYixnQkFBZ0IsRUFBSyxnQkFBTyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUM7SUFDMUMsbUJBQW1CLEVBQUUsZ0JBQU8sQ0FBQyxPQUFPLENBQUMsSUFB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N0IsQ0FBQztJQUVELEtBQUssQ0FBQyxrQkFBa0IsQ0FBRSxXQUFXO1FBQ2pDLE9BQU8sOEJBQWlCLENBQUMsV0FBVyxDQUFDLENBQUMsTUFBTSxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUMsSUFBSSxDQUFDLG1CQUFtQixDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsV0FBVyxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUM7SUFDNUgsQ0FBQztJQUdELGdCQUFnQjtJQUNoQixLQUFLLENBQUMsWUFBWSxDQUFFLEVBQUUsRUFBRSxLQUFLLEVBQUUsTUFBTSxFQUFFLFlBQVksRUFBRSxhQUFhO1FBQzlELE1BQU0sSUFBSSxDQUFDLE9BQU8sQ0FBQyxZQUFZLENBQUMsRUFBRSxFQUFFLEtBQUssRUFBRSxNQUFNLEVBQUUsWUFBWSxFQUFFLGFBQWEsQ0FBQyxDQUFDO0lBQ3BGLENBQUM7SUFFRCxLQUFLLENBQUMsY0FBYyxDQUFFLEVBQUU7UUFDcEIsTUFBTSxJQUFJLENBQUMsT0FBTyxDQUFDLGNBQWMsQ0FBQyxFQUFFLENBQUMsQ0FBQztJQUMxQyxDQUFDO0lBR0QsS0FBSyxDQUFDLGNBQWMsQ0FBRSxFQUFFLEVBQUUsY0FBYztRQUNwQyxNQUFNLElBQUksQ0FBQyxPQUFPLENBQUMsY0FBYyxDQUFDLEVBQUUsRUFBRSxjQUFjLENBQUMsQ0FBQztJQUMxRCxDQUFDO0lBRUQsS0FBSyxDQUFDLGVBQWUsQ0FBRSxFQUFFLEVBQUUsU0FBUyxFQUFFLE9BQU87UUFDekMsTUFBTSxJQUFJLENBQUMsT0FBTyxDQUFDLGVBQWUsQ0FBQyxFQUFFLEVBQUUsU0FBUyxFQUFFLE9BQU8sRUFBRSxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUM7SUFDaEYsQ0FBQztDQUNKLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBwYXJzZSBhcyBwYXJzZVVybCB9IGZyb20gJ3VybCc7XHJcbmltcG9ydCBQcm9taXNlIGZyb20gJ3BpbmtpZSc7XHJcbmltcG9ydCB7IHByb21pc2lmeSB9IGZyb20gJ3V0aWwnO1xyXG5pbXBvcnQgcGFyc2VDYXBhYmlsaXRpZXMgZnJvbSAnZGVzaXJlZC1jYXBhYmlsaXRpZXMnO1xyXG5pbXBvcnQgeyBwaWNrQnkgfSBmcm9tICdsb2Rhc2gnO1xyXG5pbXBvcnQgQnJvd3NlcnN0YWNrQ29ubmVjdG9yIGZyb20gJy4vY29ubmVjdG9yJztcclxuaW1wb3J0IEpTVGVzdGluZ0JhY2tlbmQgZnJvbSAnLi9iYWNrZW5kcy9qcy10ZXN0aW5nJztcclxuaW1wb3J0IEF1dG9tYXRlQmFja2VuZCBmcm9tICcuL2JhY2tlbmRzL2F1dG9tYXRlJztcclxuaW1wb3J0IEJyb3dzZXJQcm94eSBmcm9tICcuL2Jyb3dzZXItcHJveHknO1xyXG5pbXBvcnQgaXNFbnZWYXJUcnVlIGZyb20gJy4vdXRpbHMvaXMtZW52LXZhci10cnVlJztcclxuaW1wb3J0IGRiIGZyb20gJ21pbWUtZGInO1xyXG5cclxuY29uc3QgQU5EUk9JRF9QUk9YWV9SRVNQT05TRV9ERUxBWSA9IDUwMDtcclxuXHJcbmNvbnN0IGlzQXV0b21hdGVFbmFibGVkID0gKCkgPT4gaXNFbnZWYXJUcnVlKCdCUk9XU0VSU1RBQ0tfVVNFX0FVVE9NQVRFJyk7XHJcbmNvbnN0IGlzTG9jYWxFbmFibGVkICAgID0gKCkgPT4gISFwcm9jZXNzLmVudi5CUk9XU0VSU1RBQ0tfTE9DQUxfSURFTlRJRklFUiB8fCAhaXNFbnZWYXJUcnVlKCdCUk9XU0VSU1RBQ0tfTk9fTE9DQUwnKTtcclxuXHJcbmZ1bmN0aW9uIGdldE1pbWVUeXBlcyAoKSB7XHJcbiAgICBjb25zdCBtaW1lVHlwZXMgPSBPYmplY3Qua2V5cyhkYik7XHJcblxyXG4gICAgcmV0dXJuIG1pbWVUeXBlcy5maWx0ZXIobWltZVR5cGUgPT4ge1xyXG4gICAgICAgIGNvbnN0IHsgZXh0ZW5zaW9ucyB9ID0gZGJbbWltZVR5cGVdO1xyXG5cclxuICAgICAgICByZXR1cm4gZXh0ZW5zaW9ucyAmJiBleHRlbnNpb25zLmxlbmd0aDtcclxuICAgIH0pLmpvaW4oJywnKTtcclxufVxyXG5cclxubW9kdWxlLmV4cG9ydHMgPSB7XHJcbiAgICAvLyBNdWx0aXBsZSBicm93c2VycyBzdXBwb3J0XHJcbiAgICBpc011bHRpQnJvd3NlcjogdHJ1ZSxcclxuXHJcbiAgICBiYWNrZW5kOiBudWxsLFxyXG5cclxuICAgIGNvbm5lY3RvclByb21pc2U6ICAgIFByb21pc2UucmVzb2x2ZShudWxsKSxcclxuICAgIGJyb3dzZXJQcm94eVByb21pc2U6IFByb21pc2UucmVzb2x2ZShudWxsKSxcclxuXHJcbiAgICB3b3JrZXJzOiAgICAgICB7fSxcclxuICAgIHBsYXRmb3Jtc0luZm86IFtdLFxyXG4gICAgYnJvd3Nlck5hbWVzOiAgW10sXHJcblxyXG4gICAgX2NyZWF0ZUNvbm5lY3RvciAoKSB7XHJcbiAgICAgICAgdGhpcy5jb25uZWN0b3JQcm9taXNlID0gdGhpcy5jb25uZWN0b3JQcm9taXNlXHJcbiAgICAgICAgICAgIC50aGVuKGFzeW5jIGNvbm5lY3RvciA9PiB7XHJcbiAgICAgICAgICAgICAgICBpZiAoIWNvbm5lY3Rvcikge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbm5lY3RvciA9IG5ldyBCcm93c2Vyc3RhY2tDb25uZWN0b3IocHJvY2Vzcy5lbnZbJ0JST1dTRVJTVEFDS19BQ0NFU1NfS0VZJ10pO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICBhd2FpdCBjb25uZWN0b3IuY3JlYXRlKCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGNvbm5lY3RvcjtcclxuICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIHJldHVybiB0aGlzLmNvbm5lY3RvclByb21pc2U7XHJcbiAgICB9LFxyXG5cclxuICAgIF9kaXNwb3NlQ29ubmVjdG9yICgpIHtcclxuICAgICAgICB0aGlzLmNvbm5lY3RvclByb21pc2UgPSB0aGlzLmNvbm5lY3RvclByb21pc2VcclxuICAgICAgICAgICAgLnRoZW4oYXN5bmMgY29ubmVjdG9yID0+IHtcclxuICAgICAgICAgICAgICAgIGlmIChjb25uZWN0b3IpXHJcbiAgICAgICAgICAgICAgICAgICAgYXdhaXQgY29ubmVjdG9yLmRlc3Ryb3koKTtcclxuXHJcbiAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDtcclxuICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIHJldHVybiB0aGlzLmNvbm5lY3RvclByb21pc2U7XHJcbiAgICB9LFxyXG5cclxuICAgIF9nZXRCcm93c2VyUHJveHkgKGhvc3QsIHBvcnQpIHtcclxuICAgICAgICB0aGlzLmJyb3dzZXJQcm94eVByb21pc2UgPSB0aGlzLmJyb3dzZXJQcm94eVByb21pc2VcclxuICAgICAgICAgICAgLnRoZW4oYXN5bmMgYnJvd3NlclByb3h5ID0+IHtcclxuICAgICAgICAgICAgICAgIGlmICghYnJvd3NlclByb3h5KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgYnJvd3NlclByb3h5ID0gbmV3IEJyb3dzZXJQcm94eShob3N0LCBwb3J0LCB7IHJlc3BvbnNlRGVsYXk6IEFORFJPSURfUFJPWFlfUkVTUE9OU0VfREVMQVkgfSk7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIGF3YWl0IGJyb3dzZXJQcm94eS5pbml0KCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGJyb3dzZXJQcm94eTtcclxuICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIHJldHVybiB0aGlzLmJyb3dzZXJQcm94eVByb21pc2U7XHJcbiAgICB9LFxyXG5cclxuICAgIF9kaXNwb3NlQnJvd3NlclByb3h5ICgpIHtcclxuICAgICAgICB0aGlzLmJyb3dzZXJQcm94eVByb21pc2UgPSB0aGlzLmJyb3dzZXJQcm94eVByb21pc2VcclxuICAgICAgICAgICAgLnRoZW4oYXN5bmMgYnJvd3NlclByb3h5ID0+IHtcclxuICAgICAgICAgICAgICAgIGlmIChicm93c2VyUHJveHkpXHJcbiAgICAgICAgICAgICAgICAgICAgYXdhaXQgYnJvd3NlclByb3h5LmRpc3Bvc2UoKTtcclxuXHJcbiAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDtcclxuICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIHJldHVybiB0aGlzLmJyb3dzZXJQcm94eVByb21pc2U7XHJcbiAgICB9LFxyXG5cclxuICAgIGFzeW5jIF9nZXREZXZpY2VMaXN0ICgpIHtcclxuICAgICAgICB0aGlzLnBsYXRmb3Jtc0luZm8gPSBhd2FpdCB0aGlzLmJhY2tlbmQuZ2V0QnJvd3NlcnNMaXN0KCk7XHJcbiAgICB9LFxyXG5cclxuICAgIF9jcmVhdGVRdWVyeSAoY2FwYWJpbGl0aWVzKSB7XHJcbiAgICAgICAgdmFyIHsgYnJvd3Nlck5hbWUsIGJyb3dzZXJWZXJzaW9uLCBwbGF0Zm9ybSB9ID0gcGFyc2VDYXBhYmlsaXRpZXMoY2FwYWJpbGl0aWVzKVswXTtcclxuXHJcbiAgICAgICAgYnJvd3Nlck5hbWUgPSBicm93c2VyTmFtZS50b0xvd2VyQ2FzZSgpO1xyXG5cclxuICAgICAgICBpZiAoYnJvd3Nlck5hbWUgPT09ICdpbnRlcm5ldCBleHBsb3JlcicpXHJcbiAgICAgICAgICAgIGJyb3dzZXJOYW1lID0gJ2llJztcclxuXHJcbiAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgICAgbmFtZTogICAgIGJyb3dzZXJOYW1lLFxyXG4gICAgICAgICAgICB2ZXJzaW9uOiAgYnJvd3NlclZlcnNpb24udG9Mb3dlckNhc2UoKSxcclxuICAgICAgICAgICAgcGxhdGZvcm06IHBsYXRmb3JtLnRvTG93ZXJDYXNlKClcclxuICAgICAgICB9O1xyXG4gICAgfSxcclxuXHJcbiAgICBfZ2VuZXJhdGVCYXNpY0NhcGFiaWxpdGllcyAoYnJvd3Nlck5hbWUpIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5fZmlsdGVyUGxhdGZvcm1JbmZvKHRoaXMuX2NyZWF0ZVF1ZXJ5KGJyb3dzZXJOYW1lKSlbMF07XHJcbiAgICB9LFxyXG5cclxuICAgIF9nZXRDYXBhYmlsaXRpZXNGcm9tRW52aXJvbm1lbnQgKCkge1xyXG4gICAgICAgIC8vIE5PVEU6IFRoaXMgZnVuY3Rpb24gbWFwcyBlbnYgdmFycyB0byBicm93c2Vyc3RhY2sgY2FwYWJpbGl0aWVzLlxyXG4gICAgICAgIC8vIEZvciB0aGUgZnVsbCBsaXN0IG9mIGNhcGFiaWxpdGllcywgc2VlIGh0dHBzOi8vd3d3LmJyb3dzZXJzdGFjay5jb20vYXV0b21hdGUvY2FwYWJpbGl0aWVzXHJcblxyXG4gICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgICdidWlsZCc6ICAgICAgICAgICAgICAgICAgICAgICBwcm9jZXNzLmVudlsnQlJPV1NFUlNUQUNLX0JVSUxEX0lEJ10sXHJcbiAgICAgICAgICAgICdwcm9qZWN0JzogICAgICAgICAgICAgICAgICAgICBwcm9jZXNzLmVudlsnQlJPV1NFUlNUQUNLX1BST0pFQ1RfTkFNRSddLFxyXG4gICAgICAgICAgICAncmVzb2x1dGlvbic6ICAgICAgICAgICAgICAgICAgcHJvY2Vzcy5lbnZbJ0JST1dTRVJTVEFDS19ESVNQTEFZX1JFU09MVVRJT04nXSxcclxuICAgICAgICAgICAgJ25hbWUnOiAgICAgICAgICAgICAgICAgICAgICAgIHByb2Nlc3MuZW52WydCUk9XU0VSU1RBQ0tfVEVTVF9SVU5fTkFNRSddLFxyXG4gICAgICAgICAgICAnYnJvd3NlcnN0YWNrLmRlYnVnJzogICAgICAgICAgcHJvY2Vzcy5lbnZbJ0JST1dTRVJTVEFDS19ERUJVRyddLFxyXG4gICAgICAgICAgICAnYnJvd3NlcnN0YWNrLmNvbnNvbGUnOiAgICAgICAgcHJvY2Vzcy5lbnZbJ0JST1dTRVJTVEFDS19DT05TT0xFJ10sXHJcbiAgICAgICAgICAgICdicm93c2Vyc3RhY2submV0d29ya0xvZ3MnOiAgICBwcm9jZXNzLmVudlsnQlJPV1NFUlNUQUNLX05FVFdPUktfTE9HUyddLFxyXG4gICAgICAgICAgICAnYnJvd3NlcnN0YWNrLnZpZGVvJzogICAgICAgICAgcHJvY2Vzcy5lbnZbJ0JST1dTRVJTVEFDS19WSURFTyddLFxyXG4gICAgICAgICAgICAnYnJvd3NlcnN0YWNrLnRpbWV6b25lJzogICAgICAgcHJvY2Vzcy5lbnZbJ0JST1dTRVJTVEFDS19USU1FWk9ORSddLFxyXG4gICAgICAgICAgICAnYnJvd3NlcnN0YWNrLmdlb0xvY2F0aW9uJzogICAgcHJvY2Vzcy5lbnZbJ0JST1dTRVJTVEFDS19HRU9fTE9DQVRJT04nXSxcclxuICAgICAgICAgICAgJ2Jyb3dzZXJzdGFjay5jdXN0b21OZXR3b3JrJzogIHByb2Nlc3MuZW52WydCUk9XU0VSU1RBQ0tfQ1VTVE9NX05FVFdPUksnXSxcclxuICAgICAgICAgICAgJ2Jyb3dzZXJzdGFjay5uZXR3b3JrUHJvZmlsZSc6IHByb2Nlc3MuZW52WydCUk9XU0VSU1RBQ0tfTkVUV09SS19QUk9GSUxFJ10sXHJcbiAgICAgICAgICAgICdhY2NlcHRTc2xDZXJ0cyc6ICAgICAgICAgICAgICBwcm9jZXNzLmVudlsnQlJPV1NFUlNUQUNLX0FDQ0VQVF9TU0xfQ0VSVFMnXVxyXG4gICAgICAgIH07XHJcbiAgICB9LFxyXG5cclxuICAgIF9nZXRDYXBhYmlsaXRpZXNGcm9tQ29uZmlnICgpIHtcclxuICAgICAgICBjb25zdCBjb25maWdQYXRoID0gcHJvY2Vzcy5lbnYuQlJPV1NFUlNUQUNLX0NBUEFCSUxJVElFU19DT05GSUdfUEFUSDtcclxuXHJcbiAgICAgICAgaWYgKCFjb25maWdQYXRoKVxyXG4gICAgICAgICAgICByZXR1cm4ge307XHJcblxyXG4gICAgICAgIHJldHVybiByZXF1aXJlKGNvbmZpZ1BhdGgpO1xyXG4gICAgfSxcclxuXHJcbiAgICBfZ2V0QWRkaXRpb25hbENhcGFiaWxpdGllcyAoKSB7XHJcbiAgICAgICAgY29uc3QgY2FwYWJpbGl0aWVzRnJvbUVudmlyb25tZW50ID0gcGlja0J5KHRoaXMuX2dldENhcGFiaWxpdGllc0Zyb21FbnZpcm9ubWVudCgpLCB2YWx1ZSA9PiB2YWx1ZSAhPT0gdm9pZCAwKTtcclxuXHJcbiAgICAgICAgcmV0dXJuIHsgLi4udGhpcy5fZ2V0Q2FwYWJpbGl0aWVzRnJvbUNvbmZpZygpLCAuLi5jYXBhYmlsaXRpZXNGcm9tRW52aXJvbm1lbnQgfTtcclxuICAgIH0sXHJcblxyXG4gICAgX2ZpbHRlclBsYXRmb3JtSW5mbyAocXVlcnkpIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5wbGF0Zm9ybXNJbmZvXHJcbiAgICAgICAgICAgIC5maWx0ZXIoaW5mbyA9PiB7XHJcbiAgICAgICAgICAgICAgICB2YXIgYnJvd3Nlck5hbWVNYXRjaGVkID0gaW5mb1snYnJvd3NlciddICYmIGluZm9bJ2Jyb3dzZXInXS50b0xvd2VyQ2FzZSgpID09PSBxdWVyeS5uYW1lO1xyXG4gICAgICAgICAgICAgICAgdmFyIGRldmljZU5hbWVNYXRjaGVkICA9IGluZm9bJ2RldmljZSddICYmIGluZm9bJ2RldmljZSddLnRvTG93ZXJDYXNlKCkgPT09IHF1ZXJ5Lm5hbWU7XHJcblxyXG4gICAgICAgICAgICAgICAgdmFyIGJyb3dzZXJWZXJzaW9uTWF0Y2hlZCAgPSBpbmZvWydicm93c2VyX3ZlcnNpb24nXSAmJiBOdW1iZXIoaW5mb1snYnJvd3Nlcl92ZXJzaW9uJ10pID09PSBOdW1iZXIocXVlcnkudmVyc2lvbik7XHJcbiAgICAgICAgICAgICAgICB2YXIgcGxhdGZvcm1WZXJzaW9uTWF0Y2hlZCA9IGluZm9bJ29zX3ZlcnNpb24nXSAmJiBOdW1iZXIoaW5mb1snb3NfdmVyc2lvbiddKSA9PT0gTnVtYmVyKHF1ZXJ5LnZlcnNpb24pO1xyXG4gICAgICAgICAgICAgICAgdmFyIHBsYXRmb3JtTmFtZU1hdGNoZWQgICAgPSBpbmZvWydvcyddLnRvTG93ZXJDYXNlKCkgPT09IHF1ZXJ5LnBsYXRmb3JtIHx8XHJcbiAgICAgICAgICAgICAgICAgICAgYCR7aW5mb1snb3MnXS50b0xvd2VyQ2FzZSgpfSAke2luZm9bJ29zX3ZlcnNpb24nXS50b0xvd2VyQ2FzZSgpfWAgPT09IHF1ZXJ5LnBsYXRmb3JtO1xyXG5cclxuICAgICAgICAgICAgICAgIHZhciBpc0FueVZlcnNpb24gID0gcXVlcnkudmVyc2lvbiA9PT0gJ2FueSc7XHJcbiAgICAgICAgICAgICAgICB2YXIgaXNBbnlQbGF0Zm9ybSA9IHF1ZXJ5LnBsYXRmb3JtID09PSAnYW55JztcclxuXHJcbiAgICAgICAgICAgICAgICB2YXIgZGVza3RvcEJyb3dzZXJNYXRjaGVkID0gYnJvd3Nlck5hbWVNYXRjaGVkICYmXHJcbiAgICAgICAgICAgICAgICAgICAgKGJyb3dzZXJWZXJzaW9uTWF0Y2hlZCB8fCBpc0FueVZlcnNpb24pICYmXHJcbiAgICAgICAgICAgICAgICAgICAgKHBsYXRmb3JtTmFtZU1hdGNoZWQgfHwgaXNBbnlQbGF0Zm9ybSk7XHJcblxyXG4gICAgICAgICAgICAgICAgdmFyIG1vYmlsZUJyb3dzZXJNYXRjaGVkID0gZGV2aWNlTmFtZU1hdGNoZWQgJiZcclxuICAgICAgICAgICAgICAgICAgICAocGxhdGZvcm1WZXJzaW9uTWF0Y2hlZCB8fCBpc0FueVZlcnNpb24pO1xyXG5cclxuICAgICAgICAgICAgICAgIHJldHVybiBkZXNrdG9wQnJvd3Nlck1hdGNoZWQgfHwgbW9iaWxlQnJvd3Nlck1hdGNoZWQ7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgfSxcclxuXHJcbiAgICBfZ2VuZXJhdGVCcm93c2VyTmFtZXMgKCkge1xyXG4gICAgICAgIHRoaXMuYnJvd3Nlck5hbWVzID0gdGhpcy5wbGF0Zm9ybXNJbmZvXHJcbiAgICAgICAgICAgIC5tYXAoaW5mbyA9PiB7XHJcbiAgICAgICAgICAgICAgICB2YXIgaXNEZXNrdG9wID0gIWluZm9bJ2RldmljZSddO1xyXG4gICAgICAgICAgICAgICAgdmFyIG5hbWUgICAgICA9IGlzRGVza3RvcCA/IGluZm9bJ2Jyb3dzZXInXSA6IGluZm9bJ2RldmljZSddO1xyXG4gICAgICAgICAgICAgICAgdmFyIHZlcnNpb24gICA9IGlzRGVza3RvcCA/IGluZm9bJ2Jyb3dzZXJfdmVyc2lvbiddIDogaW5mb1snb3NfdmVyc2lvbiddO1xyXG4gICAgICAgICAgICAgICAgdmFyIHBsYXRmb3JtICA9IGlzRGVza3RvcCA/IGAke2luZm9bJ29zJ119ICR7aW5mb1snb3NfdmVyc2lvbiddfWAgOiAnJztcclxuXHJcbiAgICAgICAgICAgICAgICByZXR1cm4gYCR7bmFtZX1AJHt2ZXJzaW9ufSR7cGxhdGZvcm0gPyAnOicgKyBwbGF0Zm9ybSA6ICcnfWA7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgfSxcclxuXHJcbiAgICBfcHJlcGFyZUNocm9tZUNhcGFiaWxpdGllcyAoY2FwYWJpbGl0aWVzKSB7XHJcbiAgICAgICAgaWYgKHByb2Nlc3MuZW52WydCUk9XU0VSU1RBQ0tfQ0hST01FX0FSR1MnXSAmJiBwcm9jZXNzLmVudlsnQlJPV1NFUlNUQUNLX0NIUk9NRV9BUkdTJ10ubGVuZ3RoID4gMClcclxuICAgICAgICAgICAgY2FwYWJpbGl0aWVzLmNocm9tZU9wdGlvbnMgPSB7IGFyZ3M6IFtwcm9jZXNzLmVudlsnQlJPV1NFUlNUQUNLX0NIUk9NRV9BUkdTJ11dIH07XHJcbiAgICB9LFxyXG5cclxuICAgIGFzeW5jIF9wcmVwYXJlRmlyZWZveENhcGFiaWxpdGllcyAoY2FwYWJpbGl0aWVzKSB7XHJcbiAgICAgICAgaWYgKCFwcm9jZXNzLmVudlsnQlJPV1NFUlNUQUNLX1VTRV9BVVRPTUFURSddKVxyXG4gICAgICAgICAgICByZXR1cm47XHJcblxyXG4gICAgICAgIGNvbnN0IEZpcmVmb3hQcm9maWxlID0gcmVxdWlyZSgnZmlyZWZveC1wcm9maWxlJyk7XHJcbiAgICAgICAgY29uc3QgcHJvZmlsZSAgICAgICAgPSBuZXcgRmlyZWZveFByb2ZpbGUoKTtcclxuXHJcbiAgICAgICAgcHJvZmlsZS5kZWZhdWx0UHJlZmVyZW5jZXMgPSB7fTtcclxuXHJcbiAgICAgICAgcHJvZmlsZS5zZXRQcmVmZXJlbmNlKCdicm93c2VyLmhlbHBlckFwcHMubmV2ZXJBc2suc2F2ZVRvRGlzaycsIGdldE1pbWVUeXBlcygpKTtcclxuICAgICAgICBwcm9maWxlLnVwZGF0ZVByZWZlcmVuY2VzKCk7XHJcblxyXG4gICAgICAgIGNhcGFiaWxpdGllc1snZmlyZWZveF9wcm9maWxlJ10gPSBhd2FpdCBwcm9taXNpZnkocHJvZmlsZS5lbmNvZGVkKS5iaW5kKHByb2ZpbGUpKCk7XHJcbiAgICB9LFxyXG5cclxuICAgIGFzeW5jIF9lbmNvZGVGaXJlZm94UHJvZmlsZSAocHJvZmlsZSkge1xyXG4gICAgICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XHJcbiAgICAgICAgICAgIHByb2ZpbGUuZW5jb2RlZChmdW5jdGlvbiAoZXJyLCBlbmNvZGVkUHJvZmlsZSkge1xyXG4gICAgICAgICAgICAgICAgaWYgKGVycilcclxuICAgICAgICAgICAgICAgICAgICByZWplY3QoZXJyKTtcclxuICAgICAgICAgICAgICAgIGVsc2VcclxuICAgICAgICAgICAgICAgICAgICByZXNvbHZlKGVuY29kZWRQcm9maWxlKTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9LFxyXG5cclxuICAgIC8vIFJlcXVpcmVkIC0gbXVzdCBiZSBpbXBsZW1lbnRlZFxyXG4gICAgLy8gQnJvd3NlciBjb250cm9sXHJcbiAgICBhc3luYyBvcGVuQnJvd3NlciAoaWQsIHBhZ2VVcmwsIGJyb3dzZXJOYW1lKSB7XHJcbiAgICAgICAgY29uc3QgY2FwYWJpbGl0aWVzID0ge1xyXG4gICAgICAgICAgICAuLi50aGlzLl9nZW5lcmF0ZUJhc2ljQ2FwYWJpbGl0aWVzKGJyb3dzZXJOYW1lKSxcclxuICAgICAgICAgICAgLi4udGhpcy5fZ2V0QWRkaXRpb25hbENhcGFiaWxpdGllcygpXHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgY2FwYWJpbGl0aWVzLmxvY2FsICAgICAgICAgICA9IGlzTG9jYWxFbmFibGVkKCk7XHJcblxyXG4gICAgICAgIC8vIEdpdmUgcHJlZmVyZW5jZSB0byB0aGUgYWxyZWFkeSBydW5uaW5nIGxvY2FsIGlkZW50aWZpZXJcclxuICAgICAgICBjYXBhYmlsaXRpZXMubG9jYWxJZGVudGlmaWVyID0gcHJvY2Vzcy5lbnYuQlJPV1NFUlNUQUNLX0xPQ0FMX0lERU5USUZJRVI7XHJcblxyXG4gICAgICAgIGlmIChjYXBhYmlsaXRpZXMubG9jYWwgJiYgIWNhcGFiaWxpdGllcy5sb2NhbElkZW50aWZpZXIpIHtcclxuICAgICAgICAgICAgY29uc3QgY29ubmVjdG9yID0gYXdhaXQgdGhpcy5fY3JlYXRlQ29ubmVjdG9yKCk7XHJcblxyXG4gICAgICAgICAgICBjYXBhYmlsaXRpZXMubG9jYWxJZGVudGlmaWVyID0gY29ubmVjdG9yLmNvbm5lY3Rvckluc3RhbmNlLmxvY2FsSWRlbnRpZmllckZsYWc7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAoY2FwYWJpbGl0aWVzLm9zLnRvTG93ZXJDYXNlKCkgPT09ICdhbmRyb2lkJykge1xyXG4gICAgICAgICAgICBjb25zdCBwYXJzZWRQYWdlVXJsID0gcGFyc2VVcmwocGFnZVVybCk7XHJcbiAgICAgICAgICAgIGNvbnN0IGJyb3dzZXJQcm94eSAgPSBhd2FpdCB0aGlzLl9nZXRCcm93c2VyUHJveHkocGFyc2VkUGFnZVVybC5ob3N0bmFtZSwgcGFyc2VkUGFnZVVybC5wb3J0KTtcclxuXHJcbiAgICAgICAgICAgIHBhZ2VVcmwgPSAnaHR0cDovLycgKyBicm93c2VyUHJveHkudGFyZ2V0SG9zdCArICc6JyArIGJyb3dzZXJQcm94eS5wcm94eVBvcnQgKyBwYXJzZWRQYWdlVXJsLnBhdGg7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAoIWNhcGFiaWxpdGllcy5uYW1lKVxyXG4gICAgICAgICAgICBjYXBhYmlsaXRpZXMubmFtZSA9IGBUZXN0Q2FmZSB0ZXN0IHJ1biAke2lkfWA7XHJcblxyXG4gICAgICAgIGlmIChicm93c2VyTmFtZS5pbmNsdWRlcygnY2hyb21lJykpXHJcbiAgICAgICAgICAgIHRoaXMuX3ByZXBhcmVDaHJvbWVDYXBhYmlsaXRpZXMoY2FwYWJpbGl0aWVzKTtcclxuXHJcbiAgICAgICAgaWYgKGJyb3dzZXJOYW1lLmluY2x1ZGVzKCdmaXJlZm94JykpXHJcbiAgICAgICAgICAgIGF3YWl0IHRoaXMuX3ByZXBhcmVGaXJlZm94Q2FwYWJpbGl0aWVzKGNhcGFiaWxpdGllcyk7XHJcblxyXG4gICAgICAgIGF3YWl0IHRoaXMuYmFja2VuZC5vcGVuQnJvd3NlcihpZCwgcGFnZVVybCwgY2FwYWJpbGl0aWVzKTtcclxuXHJcbiAgICAgICAgdGhpcy5zZXRVc2VyQWdlbnRNZXRhSW5mbyhpZCwgdGhpcy5iYWNrZW5kLmdldFNlc3Npb25VcmwoaWQpKTtcclxuICAgIH0sXHJcblxyXG4gICAgYXN5bmMgY2xvc2VCcm93c2VyIChpZCkge1xyXG4gICAgICAgIGF3YWl0IHRoaXMuYmFja2VuZC5jbG9zZUJyb3dzZXIoaWQpO1xyXG4gICAgfSxcclxuXHJcbiAgICAvLyBPcHRpb25hbCAtIGltcGxlbWVudCBtZXRob2RzIHlvdSBuZWVkLCByZW1vdmUgb3RoZXIgbWV0aG9kc1xyXG4gICAgLy8gSW5pdGlhbGl6YXRpb25cclxuICAgIGFzeW5jIGluaXQgKCkge1xyXG4gICAgICAgIHZhciByZXBvcnRXYXJuaW5nID0gKC4uLmFyZ3MpID0+IHRoaXMucmVwb3J0V2FybmluZyguLi5hcmdzKTtcclxuXHJcbiAgICAgICAgdGhpcy5iYWNrZW5kID0gaXNBdXRvbWF0ZUVuYWJsZWQoKSA/IG5ldyBBdXRvbWF0ZUJhY2tlbmQocmVwb3J0V2FybmluZykgOiBuZXcgSlNUZXN0aW5nQmFja2VuZChyZXBvcnRXYXJuaW5nKTtcclxuXHJcbiAgICAgICAgYXdhaXQgdGhpcy5fZ2V0RGV2aWNlTGlzdCgpO1xyXG5cclxuICAgICAgICB0aGlzLl9nZW5lcmF0ZUJyb3dzZXJOYW1lcygpO1xyXG4gICAgfSxcclxuXHJcbiAgICBhc3luYyBkaXNwb3NlICgpIHtcclxuICAgICAgICBhd2FpdCB0aGlzLl9kaXNwb3NlQ29ubmVjdG9yKCk7XHJcbiAgICAgICAgYXdhaXQgdGhpcy5fZGlzcG9zZUJyb3dzZXJQcm94eSgpO1xyXG4gICAgfSxcclxuXHJcblxyXG4gICAgLy8gQnJvd3NlciBuYW1lcyBoYW5kbGluZ1xyXG4gICAgYXN5bmMgZ2V0QnJvd3Nlckxpc3QgKCkge1xyXG4gICAgICAgIHJldHVybiB0aGlzLmJyb3dzZXJOYW1lcztcclxuICAgIH0sXHJcblxyXG4gICAgYXN5bmMgaXNWYWxpZEJyb3dzZXJOYW1lIChicm93c2VyTmFtZSkge1xyXG4gICAgICAgIHJldHVybiBwYXJzZUNhcGFiaWxpdGllcyhicm93c2VyTmFtZSkubGVuZ3RoID09PSAxICYmICEhdGhpcy5fZmlsdGVyUGxhdGZvcm1JbmZvKHRoaXMuX2NyZWF0ZVF1ZXJ5KGJyb3dzZXJOYW1lKSkubGVuZ3RoO1xyXG4gICAgfSxcclxuXHJcblxyXG4gICAgLy8gRXh0cmEgbWV0aG9kc1xyXG4gICAgYXN5bmMgcmVzaXplV2luZG93IChpZCwgd2lkdGgsIGhlaWdodCwgY3VycmVudFdpZHRoLCBjdXJyZW50SGVpZ2h0KSB7XHJcbiAgICAgICAgYXdhaXQgdGhpcy5iYWNrZW5kLnJlc2l6ZVdpbmRvdyhpZCwgd2lkdGgsIGhlaWdodCwgY3VycmVudFdpZHRoLCBjdXJyZW50SGVpZ2h0KTtcclxuICAgIH0sXHJcblxyXG4gICAgYXN5bmMgbWF4aW1pemVXaW5kb3cgKGlkKSB7XHJcbiAgICAgICAgYXdhaXQgdGhpcy5iYWNrZW5kLm1heGltaXplV2luZG93KGlkKTtcclxuICAgIH0sXHJcblxyXG5cclxuICAgIGFzeW5jIHRha2VTY3JlZW5zaG90IChpZCwgc2NyZWVuc2hvdFBhdGgpIHtcclxuICAgICAgICBhd2FpdCB0aGlzLmJhY2tlbmQudGFrZVNjcmVlbnNob3QoaWQsIHNjcmVlbnNob3RQYXRoKTtcclxuICAgIH0sXHJcblxyXG4gICAgYXN5bmMgcmVwb3J0Sm9iUmVzdWx0IChpZCwgam9iUmVzdWx0LCBqb2JEYXRhKSB7XHJcbiAgICAgICAgYXdhaXQgdGhpcy5iYWNrZW5kLnJlcG9ydEpvYlJlc3VsdChpZCwgam9iUmVzdWx0LCBqb2JEYXRhLCB0aGlzLkpPQl9SRVNVTFQpO1xyXG4gICAgfVxyXG59O1xyXG4iXX0=