"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (Object.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
var __rest = (this && this.__rest) || function (s, e) {
    var t = {};
    for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p) && e.indexOf(p) < 0)
        t[p] = s[p];
    if (s != null && typeof Object.getOwnPropertySymbols === "function")
        for (var i = 0, p = Object.getOwnPropertySymbols(s); i < p.length; i++) {
            if (e.indexOf(p[i]) < 0 && Object.prototype.propertyIsEnumerable.call(s, p[i]))
                t[p[i]] = s[p[i]];
        }
    return t;
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const pinkie_1 = __importDefault(require("pinkie"));
const request_promise_1 = __importDefault(require("request-promise"));
const ERROR_MESSAGES = __importStar(require("../templates/error-messages"));
const apiRequestPromise = pinkie_1.default.resolve(null);
function default_1(apiPath, params = {}) {
    if (!process.env['BROWSERSTACK_USERNAME'] || !process.env['BROWSERSTACK_ACCESS_KEY'])
        throw new Error(ERROR_MESSAGES.BROWSERSTACK_AUTHENTICATION_FAILED());
    var { body, executeImmediately } = params, queryParams = __rest(params, ["body", "executeImmediately"]);
    var opts = {
        url: apiPath.url,
        auth: {
            user: process.env['BROWSERSTACK_USERNAME'],
            pass: process.env['BROWSERSTACK_ACCESS_KEY'],
        },
        headers: {
            'user-agent': 'testcafe-browserstack',
        },
        qs: Object.assign({}, queryParams),
        method: apiPath.method || 'GET',
        json: apiPath.encoding === void 0
    };
    const proxy = process.env['BROWSERSTACK_PROXY'];
    if (proxy)
        opts.proxy = `http://${proxy}`;
    if (body)
        opts.body = body;
    if (apiPath.encoding !== void 0)
        opts.encoding = apiPath.encoding;
    const chainPromise = executeImmediately ? pinkie_1.default.resolve(null) : apiRequestPromise;
    const currentRequestPromise = chainPromise
        .then(() => request_promise_1.default(opts))
        .catch(error => {
        if (error.statusCode === 401)
            throw new Error(ERROR_MESSAGES.BROWSERSTACK_AUTHENTICATION_FAILED());
        throw error;
    });
    return currentRequestPromise;
}
exports.default = default_1;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVxdWVzdC1hcGkuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvdXRpbHMvcmVxdWVzdC1hcGkuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFBQSxvREFBNkI7QUFDN0Isc0VBQXNDO0FBQ3RDLDRFQUE4RDtBQUU5RCxNQUFNLGlCQUFpQixHQUFHLGdCQUFPLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDO0FBRWhELG1CQUF5QixPQUFPLEVBQUUsTUFBTSxHQUFHLEVBQUU7SUFDekMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsdUJBQXVCLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMseUJBQXlCLENBQUM7UUFDaEYsTUFBTSxJQUFJLEtBQUssQ0FBQyxjQUFjLENBQUMsa0NBQWtDLEVBQUUsQ0FBQyxDQUFDO0lBRXpFLElBQUksRUFBRSxJQUFJLEVBQUUsa0JBQWtCLEtBQXFCLE1BQU0sRUFBdEIsV0FBVyxVQUFLLE1BQU0sRUFBckQsOEJBQTRDLENBQVMsQ0FBQztJQUUxRCxJQUFJLElBQUksR0FBRztRQUNQLEdBQUcsRUFBRyxPQUFPLENBQUMsR0FBRztRQUNqQixJQUFJLEVBQUU7WUFDRixJQUFJLEVBQUUsT0FBTyxDQUFDLEdBQUcsQ0FBQyx1QkFBdUIsQ0FBQztZQUMxQyxJQUFJLEVBQUUsT0FBTyxDQUFDLEdBQUcsQ0FBQyx5QkFBeUIsQ0FBQztTQUMvQztRQUVELE9BQU8sRUFBRTtZQUNMLFlBQVksRUFBRSx1QkFBdUI7U0FDeEM7UUFFRCxFQUFFLG9CQUFPLFdBQVcsQ0FBRTtRQUV0QixNQUFNLEVBQUUsT0FBTyxDQUFDLE1BQU0sSUFBSSxLQUFLO1FBQy9CLElBQUksRUFBSSxPQUFPLENBQUMsUUFBUSxLQUFLLEtBQUssQ0FBQztLQUN0QyxDQUFDO0lBRUYsTUFBTSxLQUFLLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxvQkFBb0IsQ0FBQyxDQUFDO0lBRWhELElBQUksS0FBSztRQUNMLElBQUksQ0FBQyxLQUFLLEdBQUcsVUFBVSxLQUFLLEVBQUUsQ0FBQztJQUVuQyxJQUFJLElBQUk7UUFDSixJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQztJQUVyQixJQUFJLE9BQU8sQ0FBQyxRQUFRLEtBQUssS0FBSyxDQUFDO1FBQzNCLElBQUksQ0FBQyxRQUFRLEdBQUcsT0FBTyxDQUFDLFFBQVEsQ0FBQztJQUVyQyxNQUFNLFlBQVksR0FBRyxrQkFBa0IsQ0FBQyxDQUFDLENBQUMsZ0JBQU8sQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLGlCQUFpQixDQUFDO0lBRXBGLE1BQU0scUJBQXFCLEdBQUcsWUFBWTtTQUNyQyxJQUFJLENBQUMsR0FBRyxFQUFFLENBQUMseUJBQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQztTQUN6QixLQUFLLENBQUMsS0FBSyxDQUFDLEVBQUU7UUFDWCxJQUFJLEtBQUssQ0FBQyxVQUFVLEtBQUssR0FBRztZQUN4QixNQUFNLElBQUksS0FBSyxDQUFDLGNBQWMsQ0FBQyxrQ0FBa0MsRUFBRSxDQUFDLENBQUM7UUFFekUsTUFBTSxLQUFLLENBQUM7SUFDaEIsQ0FBQyxDQUFDLENBQUM7SUFFUCxPQUFPLHFCQUFxQixDQUFDO0FBQ2pDLENBQUM7QUE5Q0QsNEJBOENDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IFByb21pc2UgZnJvbSAncGlua2llJztcclxuaW1wb3J0IHJlcXVlc3QgZnJvbSAncmVxdWVzdC1wcm9taXNlJztcclxuaW1wb3J0ICogYXMgRVJST1JfTUVTU0FHRVMgZnJvbSAnLi4vdGVtcGxhdGVzL2Vycm9yLW1lc3NhZ2VzJztcclxuXHJcbmNvbnN0IGFwaVJlcXVlc3RQcm9taXNlID0gUHJvbWlzZS5yZXNvbHZlKG51bGwpO1xyXG5cclxuZXhwb3J0IGRlZmF1bHQgZnVuY3Rpb24gKGFwaVBhdGgsIHBhcmFtcyA9IHt9KSB7XHJcbiAgICBpZiAoIXByb2Nlc3MuZW52WydCUk9XU0VSU1RBQ0tfVVNFUk5BTUUnXSB8fCAhcHJvY2Vzcy5lbnZbJ0JST1dTRVJTVEFDS19BQ0NFU1NfS0VZJ10pXHJcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKEVSUk9SX01FU1NBR0VTLkJST1dTRVJTVEFDS19BVVRIRU5USUNBVElPTl9GQUlMRUQoKSk7XHJcblxyXG4gICAgdmFyIHsgYm9keSwgZXhlY3V0ZUltbWVkaWF0ZWx5LCAuLi5xdWVyeVBhcmFtcyB9ID0gcGFyYW1zO1xyXG5cclxuICAgIHZhciBvcHRzID0ge1xyXG4gICAgICAgIHVybDogIGFwaVBhdGgudXJsLFxyXG4gICAgICAgIGF1dGg6IHtcclxuICAgICAgICAgICAgdXNlcjogcHJvY2Vzcy5lbnZbJ0JST1dTRVJTVEFDS19VU0VSTkFNRSddLFxyXG4gICAgICAgICAgICBwYXNzOiBwcm9jZXNzLmVudlsnQlJPV1NFUlNUQUNLX0FDQ0VTU19LRVknXSxcclxuICAgICAgICB9LFxyXG5cclxuICAgICAgICBoZWFkZXJzOiB7XHJcbiAgICAgICAgICAgICd1c2VyLWFnZW50JzogJ3Rlc3RjYWZlLWJyb3dzZXJzdGFjaycsXHJcbiAgICAgICAgfSxcclxuXHJcbiAgICAgICAgcXM6IHsgLi4ucXVlcnlQYXJhbXMgfSxcclxuXHJcbiAgICAgICAgbWV0aG9kOiBhcGlQYXRoLm1ldGhvZCB8fCAnR0VUJyxcclxuICAgICAgICBqc29uOiAgIGFwaVBhdGguZW5jb2RpbmcgPT09IHZvaWQgMFxyXG4gICAgfTtcclxuXHJcbiAgICBjb25zdCBwcm94eSA9IHByb2Nlc3MuZW52WydCUk9XU0VSU1RBQ0tfUFJPWFknXTtcclxuXHJcbiAgICBpZiAocHJveHkpXHJcbiAgICAgICAgb3B0cy5wcm94eSA9IGBodHRwOi8vJHtwcm94eX1gO1xyXG5cclxuICAgIGlmIChib2R5KVxyXG4gICAgICAgIG9wdHMuYm9keSA9IGJvZHk7XHJcblxyXG4gICAgaWYgKGFwaVBhdGguZW5jb2RpbmcgIT09IHZvaWQgMClcclxuICAgICAgICBvcHRzLmVuY29kaW5nID0gYXBpUGF0aC5lbmNvZGluZztcclxuXHJcbiAgICBjb25zdCBjaGFpblByb21pc2UgPSBleGVjdXRlSW1tZWRpYXRlbHkgPyBQcm9taXNlLnJlc29sdmUobnVsbCkgOiBhcGlSZXF1ZXN0UHJvbWlzZTtcclxuXHJcbiAgICBjb25zdCBjdXJyZW50UmVxdWVzdFByb21pc2UgPSBjaGFpblByb21pc2VcclxuICAgICAgICAudGhlbigoKSA9PiByZXF1ZXN0KG9wdHMpKVxyXG4gICAgICAgIC5jYXRjaChlcnJvciA9PiB7XHJcbiAgICAgICAgICAgIGlmIChlcnJvci5zdGF0dXNDb2RlID09PSA0MDEpXHJcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoRVJST1JfTUVTU0FHRVMuQlJPV1NFUlNUQUNLX0FVVEhFTlRJQ0FUSU9OX0ZBSUxFRCgpKTtcclxuXHJcbiAgICAgICAgICAgIHRocm93IGVycm9yO1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgIHJldHVybiBjdXJyZW50UmVxdWVzdFByb21pc2U7XHJcbn1cclxuIl19