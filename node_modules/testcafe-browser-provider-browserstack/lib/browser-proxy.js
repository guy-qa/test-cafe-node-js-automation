"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const http_1 = __importDefault(require("http"));
const url_1 = require("url");
const pinkie_1 = __importDefault(require("pinkie"));
module.exports = class BrowserProxy {
    constructor(targetHost, targetPort, { proxyPort, responseDelay } = {}) {
        this.targetHost = targetHost;
        this.targetPort = targetPort;
        this.proxyPort = proxyPort || 0;
        this.responseDelay = responseDelay || 0;
        this.server = http_1.default.createServer((...args) => this._onBrowserRequest(...args));
        this.server.on('connection', socket => socket.unref());
    }
    _onBrowserRequest(req, res) {
        setTimeout(() => {
            const parsedRequestUrl = url_1.parse(req.url);
            const destinationUrl = 'http://' + this.targetHost + ':' + this.targetPort + parsedRequestUrl.path;
            res.statusCode = 302;
            res.setHeader('location', destinationUrl);
            res.end();
        }, this.responseDelay);
    }
    async init() {
        return new pinkie_1.default((resolve, reject) => {
            this.server.listen(this.proxyPort, err => {
                if (err)
                    reject(err);
                else {
                    this.proxyPort = this.server.address().port;
                    resolve();
                }
            });
        });
    }
    dispose() {
        this.server.close();
    }
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYnJvd3Nlci1wcm94eS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9icm93c2VyLXByb3h5LmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBQUEsZ0RBQXdCO0FBQ3hCLDZCQUF3QztBQUN4QyxvREFBNkI7QUFHN0IsTUFBTSxDQUFDLE9BQU8sR0FBRyxNQUFNLFlBQVk7SUFDL0IsWUFBYSxVQUFVLEVBQUUsVUFBVSxFQUFFLEVBQUUsU0FBUyxFQUFFLGFBQWEsRUFBRSxHQUFHLEVBQUU7UUFDbEUsSUFBSSxDQUFDLFVBQVUsR0FBTSxVQUFVLENBQUM7UUFDaEMsSUFBSSxDQUFDLFVBQVUsR0FBTSxVQUFVLENBQUM7UUFDaEMsSUFBSSxDQUFDLFNBQVMsR0FBTyxTQUFTLElBQUksQ0FBQyxDQUFDO1FBQ3BDLElBQUksQ0FBQyxhQUFhLEdBQUcsYUFBYSxJQUFJLENBQUMsQ0FBQztRQUV4QyxJQUFJLENBQUMsTUFBTSxHQUFHLGNBQUksQ0FBQyxZQUFZLENBQUMsQ0FBQyxHQUFHLElBQUksRUFBRSxFQUFFLENBQUMsSUFBSSxDQUFDLGlCQUFpQixDQUFDLEdBQUcsSUFBSSxDQUFDLENBQUMsQ0FBQztRQUU5RSxJQUFJLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxZQUFZLEVBQUUsTUFBTSxDQUFDLEVBQUUsQ0FBQyxNQUFNLENBQUMsS0FBSyxFQUFFLENBQUMsQ0FBQztJQUMzRCxDQUFDO0lBRUQsaUJBQWlCLENBQUUsR0FBRyxFQUFFLEdBQUc7UUFDdkIsVUFBVSxDQUFDLEdBQUcsRUFBRTtZQUNaLE1BQU0sZ0JBQWdCLEdBQUcsV0FBUSxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUMzQyxNQUFNLGNBQWMsR0FBSyxTQUFTLEdBQUcsSUFBSSxDQUFDLFVBQVUsR0FBRyxHQUFHLEdBQUcsSUFBSSxDQUFDLFVBQVUsR0FBRyxnQkFBZ0IsQ0FBQyxJQUFJLENBQUM7WUFFckcsR0FBRyxDQUFDLFVBQVUsR0FBRyxHQUFHLENBQUM7WUFFckIsR0FBRyxDQUFDLFNBQVMsQ0FBQyxVQUFVLEVBQUUsY0FBYyxDQUFDLENBQUM7WUFDMUMsR0FBRyxDQUFDLEdBQUcsRUFBRSxDQUFDO1FBQ2QsQ0FBQyxFQUFFLElBQUksQ0FBQyxhQUFhLENBQUMsQ0FBQztJQUMzQixDQUFDO0lBRUQsS0FBSyxDQUFDLElBQUk7UUFDTixPQUFPLElBQUksZ0JBQU8sQ0FBQyxDQUFDLE9BQU8sRUFBRSxNQUFNLEVBQUUsRUFBRTtZQUNuQyxJQUFJLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsU0FBUyxFQUFFLEdBQUcsQ0FBQyxFQUFFO2dCQUNyQyxJQUFJLEdBQUc7b0JBQ0gsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDO3FCQUNYO29CQUNELElBQUksQ0FBQyxTQUFTLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxPQUFPLEVBQUUsQ0FBQyxJQUFJLENBQUM7b0JBRTVDLE9BQU8sRUFBRSxDQUFDO2lCQUNiO1lBQ0wsQ0FBQyxDQUFDLENBQUM7UUFDUCxDQUFDLENBQUMsQ0FBQztJQUNQLENBQUM7SUFFRCxPQUFPO1FBQ0gsSUFBSSxDQUFDLE1BQU0sQ0FBQyxLQUFLLEVBQUUsQ0FBQztJQUN4QixDQUFDO0NBQ0osQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBodHRwIGZyb20gJ2h0dHAnO1xyXG5pbXBvcnQgeyBwYXJzZSBhcyBwYXJzZVVybCB9IGZyb20gJ3VybCc7XHJcbmltcG9ydCBQcm9taXNlIGZyb20gJ3BpbmtpZSc7XHJcblxyXG5cclxubW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBCcm93c2VyUHJveHkge1xyXG4gICAgY29uc3RydWN0b3IgKHRhcmdldEhvc3QsIHRhcmdldFBvcnQsIHsgcHJveHlQb3J0LCByZXNwb25zZURlbGF5IH0gPSB7fSkge1xyXG4gICAgICAgIHRoaXMudGFyZ2V0SG9zdCAgICA9IHRhcmdldEhvc3Q7XHJcbiAgICAgICAgdGhpcy50YXJnZXRQb3J0ICAgID0gdGFyZ2V0UG9ydDtcclxuICAgICAgICB0aGlzLnByb3h5UG9ydCAgICAgPSBwcm94eVBvcnQgfHwgMDtcclxuICAgICAgICB0aGlzLnJlc3BvbnNlRGVsYXkgPSByZXNwb25zZURlbGF5IHx8IDA7XHJcblxyXG4gICAgICAgIHRoaXMuc2VydmVyID0gaHR0cC5jcmVhdGVTZXJ2ZXIoKC4uLmFyZ3MpID0+IHRoaXMuX29uQnJvd3NlclJlcXVlc3QoLi4uYXJncykpO1xyXG5cclxuICAgICAgICB0aGlzLnNlcnZlci5vbignY29ubmVjdGlvbicsIHNvY2tldCA9PiBzb2NrZXQudW5yZWYoKSk7XHJcbiAgICB9XHJcblxyXG4gICAgX29uQnJvd3NlclJlcXVlc3QgKHJlcSwgcmVzKSB7XHJcbiAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IHBhcnNlZFJlcXVlc3RVcmwgPSBwYXJzZVVybChyZXEudXJsKTtcclxuICAgICAgICAgICAgY29uc3QgZGVzdGluYXRpb25VcmwgICA9ICdodHRwOi8vJyArIHRoaXMudGFyZ2V0SG9zdCArICc6JyArIHRoaXMudGFyZ2V0UG9ydCArIHBhcnNlZFJlcXVlc3RVcmwucGF0aDtcclxuXHJcbiAgICAgICAgICAgIHJlcy5zdGF0dXNDb2RlID0gMzAyO1xyXG5cclxuICAgICAgICAgICAgcmVzLnNldEhlYWRlcignbG9jYXRpb24nLCBkZXN0aW5hdGlvblVybCk7XHJcbiAgICAgICAgICAgIHJlcy5lbmQoKTtcclxuICAgICAgICB9LCB0aGlzLnJlc3BvbnNlRGVsYXkpO1xyXG4gICAgfVxyXG5cclxuICAgIGFzeW5jIGluaXQgKCkge1xyXG4gICAgICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XHJcbiAgICAgICAgICAgIHRoaXMuc2VydmVyLmxpc3Rlbih0aGlzLnByb3h5UG9ydCwgZXJyID0+IHtcclxuICAgICAgICAgICAgICAgIGlmIChlcnIpXHJcbiAgICAgICAgICAgICAgICAgICAgcmVqZWN0KGVycik7XHJcbiAgICAgICAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLnByb3h5UG9ydCA9IHRoaXMuc2VydmVyLmFkZHJlc3MoKS5wb3J0O1xyXG5cclxuICAgICAgICAgICAgICAgICAgICByZXNvbHZlKCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIGRpc3Bvc2UgKCkge1xyXG4gICAgICAgIHRoaXMuc2VydmVyLmNsb3NlKCk7XHJcbiAgICB9XHJcbn07XHJcbiJdfQ==