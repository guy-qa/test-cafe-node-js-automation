"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const child_process_1 = __importDefault(require("child_process"));
const fs_1 = __importDefault(require("fs"));
const os_1 = __importDefault(require("os"));
const path_1 = __importDefault(require("path"));
const del_1 = __importDefault(require("del"));
const execa_1 = __importDefault(require("execa"));
const os_family_1 = __importDefault(require("os-family"));
const nanoid_1 = __importDefault(require("nanoid"));
const promisify_1 = __importDefault(require("./promisify"));
const binaries_1 = __importDefault(require("../binaries"));
const flatten_whitespace_1 = __importDefault(require("./flatten-whitespace"));
const get_environment_variable_1 = __importDefault(require("./get-environment-variable"));
const errors_1 = require("../errors");
const EXIT_CODE_REGEXP = /Exit code: (-?\d+)/;
const OPEN_PATH = '/usr/bin/open';
const TEMP_PIPE_NAME = seed => `testcafe-browser-tools-fifo-${seed}`;
const WINDOWS_DIR = get_environment_variable_1.default('SystemRoot') || 'C:\\Windows';
const SYSTEM32_DIR = path_1.default.join(WINDOWS_DIR, 'System32');
const CHCP_COM = path_1.default.join(SYSTEM32_DIR, 'chcp.com');
const POWERSHELL_DIR = path_1.default.join(SYSTEM32_DIR, 'WindowsPowerShell\\v1.0');
const POWERSHELL_BINARY = path_1.default.join(POWERSHELL_DIR, 'powershell.exe');
const POWERSHELL_ARGS = ['-NoLogo', '-NonInteractive', '-Command'];
const POWERSHELL_COMMAND_WRAPPER = command => flatten_whitespace_1.default `
    $cp = (${CHCP_COM} | Select-String '\\d+').Matches.Value;
    Try
    {
        ${CHCP_COM} 65001;
        ${command};
    }
    Finally
    {
        ${CHCP_COM} $cp;
    }
`;
function getTempPipePath() {
    return path_1.default.join(os_1.default.tmpdir(), TEMP_PIPE_NAME(nanoid_1.default()));
}
var execFilePromise = promisify_1.default(child_process_1.default.execFile);
var execPromise = promisify_1.default(child_process_1.default.exec);
function readPipe(pipePath) {
    return new Promise((resolve, reject) => {
        let data = '';
        const stream = fs_1.default.createReadStream(pipePath);
        stream.on('data', newData => {
            data += newData ? newData.toString() : '';
        });
        stream.on('end', () => resolve(data));
        stream.on('error', reject);
    });
}
function spawnApp(pipePath, binaryPath, args) {
    return new Promise((resolve, reject) => {
        const child = child_process_1.default.spawn(OPEN_PATH, ['-n', '-a', binaries_1.default.app, '--args', pipePath, binaryPath, ...args]);
        let outputData = '';
        child.on('error', reject);
        child.on('exit', code => {
            if (code)
                reject(new errors_1.NativeBinaryHasFailedError({ binary: binaryPath, exitCode: code, output: outputData }));
            else
                resolve();
        });
        function dataHandler(data) {
            outputData += String(data);
        }
        child.stdout.on('data', dataHandler);
        child.stderr.on('data', dataHandler);
    });
}
async function runWithMacApp(binaryPath, args) {
    const pipePath = getTempPipePath();
    await execPromise(`mkfifo ${pipePath}`);
    try {
        const [data] = await Promise.all([
            readPipe(pipePath),
            spawnApp(pipePath, binaryPath, args)
        ]);
        const exitCodeMatch = data.match(EXIT_CODE_REGEXP);
        if (!exitCodeMatch)
            return data;
        const exitCode = Number(exitCodeMatch[1]);
        if (exitCode)
            throw new errors_1.NativeBinaryHasFailedError({ binary: binaryPath, output: data, exitCode });
        return data;
    }
    finally {
        await del_1.default(pipePath, { force: true });
    }
}
//API
async function execFile(filePath, args) {
    try {
        if (os_family_1.default.mac)
            return await runWithMacApp(filePath, args);
        return await execFilePromise(filePath, args);
    }
    catch (err) {
        if (err instanceof errors_1.NativeBinaryHasFailedError)
            throw err;
        const errorCode = err.status || err.code;
        if (errorCode === void 0 || typeof errorCode === 'string')
            throw err;
        throw new errors_1.NativeBinaryHasFailedError({ binary: filePath, exitCode: errorCode });
    }
}
exports.execFile = execFile;
async function exec(command) {
    return execPromise(command, { env: process.env });
}
exports.exec = exec;
async function execPowershell(command) {
    const wrappedCommand = POWERSHELL_COMMAND_WRAPPER(command);
    // NOTE: We have to ignore stdin due to a problem with PowerShell 2.0
    // See https://stackoverflow.com/a/9157170/11818061 for details.
    return execa_1.default(POWERSHELL_BINARY, [...POWERSHELL_ARGS, wrappedCommand], { stdin: 'ignore' });
}
exports.execPowershell = execPowershell;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZXhlYy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy91dGlscy9leGVjLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBQUEsa0VBQXNDO0FBQ3RDLDRDQUFvQjtBQUNwQiw0Q0FBb0I7QUFDcEIsZ0RBQXdCO0FBQ3hCLDhDQUFzQjtBQUN0QixrREFBMEI7QUFDMUIsMERBQTJCO0FBQzNCLG9EQUE0QjtBQUM1Qiw0REFBb0M7QUFDcEMsMkRBQW1DO0FBQ25DLDhFQUFxRDtBQUNyRCwwRkFBZ0U7QUFDaEUsc0NBQXVEO0FBR3ZELE1BQU0sZ0JBQWdCLEdBQUcsb0JBQW9CLENBQUM7QUFFOUMsTUFBTSxTQUFTLEdBQVEsZUFBZSxDQUFDO0FBQ3ZDLE1BQU0sY0FBYyxHQUFHLElBQUksQ0FBQyxFQUFFLENBQUMsK0JBQStCLElBQUksRUFBRSxDQUFDO0FBRXJFLE1BQU0sV0FBVyxHQUFTLGtDQUFzQixDQUFDLFlBQVksQ0FBQyxJQUFJLGFBQWEsQ0FBQztBQUNoRixNQUFNLFlBQVksR0FBUSxjQUFJLENBQUMsSUFBSSxDQUFDLFdBQVcsRUFBRSxVQUFVLENBQUMsQ0FBQztBQUM3RCxNQUFNLFFBQVEsR0FBWSxjQUFJLENBQUMsSUFBSSxDQUFDLFlBQVksRUFBRSxVQUFVLENBQUMsQ0FBQztBQUM5RCxNQUFNLGNBQWMsR0FBTSxjQUFJLENBQUMsSUFBSSxDQUFDLFlBQVksRUFBRSx5QkFBeUIsQ0FBQyxDQUFDO0FBQzdFLE1BQU0saUJBQWlCLEdBQUcsY0FBSSxDQUFDLElBQUksQ0FBQyxjQUFjLEVBQUUsZ0JBQWdCLENBQUMsQ0FBQztBQUN0RSxNQUFNLGVBQWUsR0FBSyxDQUFDLFNBQVMsRUFBRSxpQkFBaUIsRUFBRSxVQUFVLENBQUMsQ0FBQztBQUVyRSxNQUFNLDBCQUEwQixHQUFHLE9BQU8sQ0FBQyxFQUFFLENBQUMsNEJBQWlCLENBQUM7YUFDbkQsUUFBUTs7O1VBR1gsUUFBUTtVQUNSLE9BQU87Ozs7VUFJUCxRQUFROztDQUVqQixDQUFDO0FBRUYsU0FBUyxlQUFlO0lBQ3BCLE9BQU8sY0FBSSxDQUFDLElBQUksQ0FBQyxZQUFFLENBQUMsTUFBTSxFQUFFLEVBQUUsY0FBYyxDQUFDLGdCQUFNLEVBQUUsQ0FBQyxDQUFDLENBQUM7QUFDNUQsQ0FBQztBQUVELElBQUksZUFBZSxHQUFHLG1CQUFTLENBQUMsdUJBQVMsQ0FBQyxRQUFRLENBQUMsQ0FBQztBQUNwRCxJQUFJLFdBQVcsR0FBTyxtQkFBUyxDQUFDLHVCQUFTLENBQUMsSUFBSSxDQUFDLENBQUM7QUFHaEQsU0FBUyxRQUFRLENBQUUsUUFBUTtJQUN2QixPQUFPLElBQUksT0FBTyxDQUFDLENBQUMsT0FBTyxFQUFFLE1BQU0sRUFBRSxFQUFFO1FBQ25DLElBQUksSUFBSSxHQUFPLEVBQUUsQ0FBQztRQUNsQixNQUFNLE1BQU0sR0FBRyxZQUFFLENBQUMsZ0JBQWdCLENBQUMsUUFBUSxDQUFDLENBQUM7UUFFN0MsTUFBTSxDQUFDLEVBQUUsQ0FBQyxNQUFNLEVBQUUsT0FBTyxDQUFDLEVBQUU7WUFDeEIsSUFBSSxJQUFJLE9BQU8sQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLFFBQVEsRUFBRSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUM7UUFDOUMsQ0FBQyxDQUFDLENBQUM7UUFFSCxNQUFNLENBQUMsRUFBRSxDQUFDLEtBQUssRUFBRSxHQUFHLEVBQUUsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztRQUN0QyxNQUFNLENBQUMsRUFBRSxDQUFDLE9BQU8sRUFBRSxNQUFNLENBQUMsQ0FBQztJQUMvQixDQUFDLENBQUMsQ0FBQztBQUNQLENBQUM7QUFFRCxTQUFTLFFBQVEsQ0FBRSxRQUFRLEVBQUUsVUFBVSxFQUFFLElBQUk7SUFDekMsT0FBTyxJQUFJLE9BQU8sQ0FBQyxDQUFDLE9BQU8sRUFBRSxNQUFNLEVBQUUsRUFBRTtRQUNuQyxNQUFNLEtBQUssR0FBRyx1QkFBUyxDQUFDLEtBQUssQ0FBQyxTQUFTLEVBQUUsQ0FBQyxJQUFJLEVBQUUsSUFBSSxFQUFFLGtCQUFRLENBQUMsR0FBRyxFQUFFLFFBQVEsRUFBRSxRQUFRLEVBQUUsVUFBVSxFQUFFLEdBQUcsSUFBSSxDQUFDLENBQUMsQ0FBQztRQUU5RyxJQUFJLFVBQVUsR0FBRyxFQUFFLENBQUM7UUFFcEIsS0FBSyxDQUFDLEVBQUUsQ0FBQyxPQUFPLEVBQUUsTUFBTSxDQUFDLENBQUM7UUFFMUIsS0FBSyxDQUFDLEVBQUUsQ0FBQyxNQUFNLEVBQUUsSUFBSSxDQUFDLEVBQUU7WUFDcEIsSUFBSSxJQUFJO2dCQUNKLE1BQU0sQ0FBQyxJQUFJLG1DQUEwQixDQUFDLEVBQUUsTUFBTSxFQUFFLFVBQVUsRUFBRSxRQUFRLEVBQUUsSUFBSSxFQUFFLE1BQU0sRUFBRSxVQUFVLEVBQUUsQ0FBQyxDQUFDLENBQUM7O2dCQUVuRyxPQUFPLEVBQUUsQ0FBQztRQUNsQixDQUFDLENBQUMsQ0FBQztRQUVILFNBQVMsV0FBVyxDQUFFLElBQUk7WUFDdEIsVUFBVSxJQUFJLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUMvQixDQUFDO1FBRUQsS0FBSyxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsTUFBTSxFQUFFLFdBQVcsQ0FBQyxDQUFDO1FBQ3JDLEtBQUssQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDLE1BQU0sRUFBRSxXQUFXLENBQUMsQ0FBQztJQUN6QyxDQUFDLENBQUMsQ0FBQztBQUNQLENBQUM7QUFFRCxLQUFLLFVBQVUsYUFBYSxDQUFFLFVBQVUsRUFBRSxJQUFJO0lBQzFDLE1BQU0sUUFBUSxHQUFHLGVBQWUsRUFBRSxDQUFDO0lBRW5DLE1BQU0sV0FBVyxDQUFDLFVBQVUsUUFBUSxFQUFFLENBQUMsQ0FBQztJQUV4QyxJQUFJO1FBQ0EsTUFBTSxDQUFDLElBQUksQ0FBQyxHQUFHLE1BQU0sT0FBTyxDQUFDLEdBQUcsQ0FBQztZQUM3QixRQUFRLENBQUMsUUFBUSxDQUFDO1lBQ2xCLFFBQVEsQ0FBQyxRQUFRLEVBQUUsVUFBVSxFQUFFLElBQUksQ0FBQztTQUN2QyxDQUFDLENBQUM7UUFFSCxNQUFNLGFBQWEsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLGdCQUFnQixDQUFDLENBQUM7UUFFbkQsSUFBSSxDQUFDLGFBQWE7WUFDZCxPQUFPLElBQUksQ0FBQztRQUVoQixNQUFNLFFBQVEsR0FBRyxNQUFNLENBQUMsYUFBYSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFFMUMsSUFBSSxRQUFRO1lBQ1IsTUFBTSxJQUFJLG1DQUEwQixDQUFDLEVBQUUsTUFBTSxFQUFFLFVBQVUsRUFBRSxNQUFNLEVBQUUsSUFBSSxFQUFFLFFBQVEsRUFBRSxDQUFDLENBQUM7UUFFekYsT0FBTyxJQUFJLENBQUM7S0FDZjtZQUNPO1FBQ0osTUFBTSxhQUFHLENBQUMsUUFBUSxFQUFFLEVBQUUsS0FBSyxFQUFFLElBQUksRUFBRSxDQUFDLENBQUM7S0FDeEM7QUFDTCxDQUFDO0FBRUQsS0FBSztBQUNFLEtBQUssVUFBVSxRQUFRLENBQUUsUUFBUSxFQUFFLElBQUk7SUFDMUMsSUFBSTtRQUNBLElBQUksbUJBQUUsQ0FBQyxHQUFHO1lBQ04sT0FBTyxNQUFNLGFBQWEsQ0FBQyxRQUFRLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFFL0MsT0FBTyxNQUFNLGVBQWUsQ0FBQyxRQUFRLEVBQUUsSUFBSSxDQUFDLENBQUM7S0FDaEQ7SUFDRCxPQUFPLEdBQUcsRUFBRTtRQUNSLElBQUksR0FBRyxZQUFZLG1DQUEwQjtZQUN6QyxNQUFNLEdBQUcsQ0FBQztRQUVkLE1BQU0sU0FBUyxHQUFHLEdBQUcsQ0FBQyxNQUFNLElBQUksR0FBRyxDQUFDLElBQUksQ0FBQztRQUV6QyxJQUFJLFNBQVMsS0FBSyxLQUFLLENBQUMsSUFBSSxPQUFPLFNBQVMsS0FBSyxRQUFRO1lBQ3JELE1BQU0sR0FBRyxDQUFDO1FBRWQsTUFBTSxJQUFJLG1DQUEwQixDQUFDLEVBQUUsTUFBTSxFQUFFLFFBQVEsRUFBRSxRQUFRLEVBQUUsU0FBUyxFQUFFLENBQUMsQ0FBQztLQUNuRjtBQUNMLENBQUM7QUFsQkQsNEJBa0JDO0FBRU0sS0FBSyxVQUFVLElBQUksQ0FBRSxPQUFPO0lBQy9CLE9BQU8sV0FBVyxDQUFDLE9BQU8sRUFBRSxFQUFFLEdBQUcsRUFBRSxPQUFPLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQztBQUN0RCxDQUFDO0FBRkQsb0JBRUM7QUFFTSxLQUFLLFVBQVUsY0FBYyxDQUFFLE9BQU87SUFDekMsTUFBTSxjQUFjLEdBQUcsMEJBQTBCLENBQUMsT0FBTyxDQUFDLENBQUM7SUFFM0QscUVBQXFFO0lBQ3JFLGdFQUFnRTtJQUNoRSxPQUFPLGVBQUssQ0FBQyxpQkFBaUIsRUFBRSxDQUFDLEdBQUcsZUFBZSxFQUFFLGNBQWMsQ0FBQyxFQUFFLEVBQUUsS0FBSyxFQUFFLFFBQVEsRUFBRSxDQUFDLENBQUM7QUFDL0YsQ0FBQztBQU5ELHdDQU1DIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGNoaWxkUHJvYyBmcm9tICdjaGlsZF9wcm9jZXNzJztcbmltcG9ydCBmcyBmcm9tICdmcyc7XG5pbXBvcnQgb3MgZnJvbSAnb3MnO1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgZGVsIGZyb20gJ2RlbCc7XG5pbXBvcnQgZXhlY2EgZnJvbSAnZXhlY2EnO1xuaW1wb3J0IE9TIGZyb20gJ29zLWZhbWlseSc7XG5pbXBvcnQgbmFub2lkIGZyb20gJ25hbm9pZCc7XG5pbXBvcnQgcHJvbWlzaWZ5IGZyb20gJy4vcHJvbWlzaWZ5JztcbmltcG9ydCBCSU5BUklFUyBmcm9tICcuLi9iaW5hcmllcyc7XG5pbXBvcnQgZmxhdHRlbldoaXRlc3BhY2UgZnJvbSAnLi9mbGF0dGVuLXdoaXRlc3BhY2UnO1xuaW1wb3J0IGdldEVudmlyb25tZW50VmFyaWFibGUgZnJvbSAnLi9nZXQtZW52aXJvbm1lbnQtdmFyaWFibGUnO1xuaW1wb3J0IHsgTmF0aXZlQmluYXJ5SGFzRmFpbGVkRXJyb3IgfSBmcm9tICcuLi9lcnJvcnMnO1xuXG5cbmNvbnN0IEVYSVRfQ09ERV9SRUdFWFAgPSAvRXhpdCBjb2RlOiAoLT9cXGQrKS87XG5cbmNvbnN0IE9QRU5fUEFUSCAgICAgID0gJy91c3IvYmluL29wZW4nO1xuY29uc3QgVEVNUF9QSVBFX05BTUUgPSBzZWVkID0+IGB0ZXN0Y2FmZS1icm93c2VyLXRvb2xzLWZpZm8tJHtzZWVkfWA7XG5cbmNvbnN0IFdJTkRPV1NfRElSICAgICAgID0gZ2V0RW52aXJvbm1lbnRWYXJpYWJsZSgnU3lzdGVtUm9vdCcpIHx8ICdDOlxcXFxXaW5kb3dzJztcbmNvbnN0IFNZU1RFTTMyX0RJUiAgICAgID0gcGF0aC5qb2luKFdJTkRPV1NfRElSLCAnU3lzdGVtMzInKTtcbmNvbnN0IENIQ1BfQ09NICAgICAgICAgID0gcGF0aC5qb2luKFNZU1RFTTMyX0RJUiwgJ2NoY3AuY29tJyk7XG5jb25zdCBQT1dFUlNIRUxMX0RJUiAgICA9IHBhdGguam9pbihTWVNURU0zMl9ESVIsICdXaW5kb3dzUG93ZXJTaGVsbFxcXFx2MS4wJyk7XG5jb25zdCBQT1dFUlNIRUxMX0JJTkFSWSA9IHBhdGguam9pbihQT1dFUlNIRUxMX0RJUiwgJ3Bvd2Vyc2hlbGwuZXhlJyk7XG5jb25zdCBQT1dFUlNIRUxMX0FSR1MgICA9IFsnLU5vTG9nbycsICctTm9uSW50ZXJhY3RpdmUnLCAnLUNvbW1hbmQnXTtcblxuY29uc3QgUE9XRVJTSEVMTF9DT01NQU5EX1dSQVBQRVIgPSBjb21tYW5kID0+IGZsYXR0ZW5XaGl0ZXNwYWNlIGBcbiAgICAkY3AgPSAoJHtDSENQX0NPTX0gfCBTZWxlY3QtU3RyaW5nICdcXFxcZCsnKS5NYXRjaGVzLlZhbHVlO1xuICAgIFRyeVxuICAgIHtcbiAgICAgICAgJHtDSENQX0NPTX0gNjUwMDE7XG4gICAgICAgICR7Y29tbWFuZH07XG4gICAgfVxuICAgIEZpbmFsbHlcbiAgICB7XG4gICAgICAgICR7Q0hDUF9DT019ICRjcDtcbiAgICB9XG5gO1xuXG5mdW5jdGlvbiBnZXRUZW1wUGlwZVBhdGggKCkge1xuICAgIHJldHVybiBwYXRoLmpvaW4ob3MudG1wZGlyKCksIFRFTVBfUElQRV9OQU1FKG5hbm9pZCgpKSk7XG59XG5cbnZhciBleGVjRmlsZVByb21pc2UgPSBwcm9taXNpZnkoY2hpbGRQcm9jLmV4ZWNGaWxlKTtcbnZhciBleGVjUHJvbWlzZSAgICAgPSBwcm9taXNpZnkoY2hpbGRQcm9jLmV4ZWMpO1xuXG5cbmZ1bmN0aW9uIHJlYWRQaXBlIChwaXBlUGF0aCkge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAgIGxldCBkYXRhICAgICA9ICcnO1xuICAgICAgICBjb25zdCBzdHJlYW0gPSBmcy5jcmVhdGVSZWFkU3RyZWFtKHBpcGVQYXRoKTtcblxuICAgICAgICBzdHJlYW0ub24oJ2RhdGEnLCBuZXdEYXRhID0+IHtcbiAgICAgICAgICAgIGRhdGEgKz0gbmV3RGF0YSA/IG5ld0RhdGEudG9TdHJpbmcoKSA6ICcnO1xuICAgICAgICB9KTtcblxuICAgICAgICBzdHJlYW0ub24oJ2VuZCcsICgpID0+IHJlc29sdmUoZGF0YSkpO1xuICAgICAgICBzdHJlYW0ub24oJ2Vycm9yJywgcmVqZWN0KTtcbiAgICB9KTtcbn1cblxuZnVuY3Rpb24gc3Bhd25BcHAgKHBpcGVQYXRoLCBiaW5hcnlQYXRoLCBhcmdzKSB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgY29uc3QgY2hpbGQgPSBjaGlsZFByb2Muc3Bhd24oT1BFTl9QQVRILCBbJy1uJywgJy1hJywgQklOQVJJRVMuYXBwLCAnLS1hcmdzJywgcGlwZVBhdGgsIGJpbmFyeVBhdGgsIC4uLmFyZ3NdKTtcblxuICAgICAgICBsZXQgb3V0cHV0RGF0YSA9ICcnO1xuXG4gICAgICAgIGNoaWxkLm9uKCdlcnJvcicsIHJlamVjdCk7XG5cbiAgICAgICAgY2hpbGQub24oJ2V4aXQnLCBjb2RlID0+IHtcbiAgICAgICAgICAgIGlmIChjb2RlKVxuICAgICAgICAgICAgICAgIHJlamVjdChuZXcgTmF0aXZlQmluYXJ5SGFzRmFpbGVkRXJyb3IoeyBiaW5hcnk6IGJpbmFyeVBhdGgsIGV4aXRDb2RlOiBjb2RlLCBvdXRwdXQ6IG91dHB1dERhdGEgfSkpO1xuICAgICAgICAgICAgZWxzZVxuICAgICAgICAgICAgICAgIHJlc29sdmUoKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgZnVuY3Rpb24gZGF0YUhhbmRsZXIgKGRhdGEpIHtcbiAgICAgICAgICAgIG91dHB1dERhdGEgKz0gU3RyaW5nKGRhdGEpO1xuICAgICAgICB9XG5cbiAgICAgICAgY2hpbGQuc3Rkb3V0Lm9uKCdkYXRhJywgZGF0YUhhbmRsZXIpO1xuICAgICAgICBjaGlsZC5zdGRlcnIub24oJ2RhdGEnLCBkYXRhSGFuZGxlcik7XG4gICAgfSk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHJ1bldpdGhNYWNBcHAgKGJpbmFyeVBhdGgsIGFyZ3MpIHtcbiAgICBjb25zdCBwaXBlUGF0aCA9IGdldFRlbXBQaXBlUGF0aCgpO1xuXG4gICAgYXdhaXQgZXhlY1Byb21pc2UoYG1rZmlmbyAke3BpcGVQYXRofWApO1xuXG4gICAgdHJ5IHtcbiAgICAgICAgY29uc3QgW2RhdGFdID0gYXdhaXQgUHJvbWlzZS5hbGwoW1xuICAgICAgICAgICAgcmVhZFBpcGUocGlwZVBhdGgpLFxuICAgICAgICAgICAgc3Bhd25BcHAocGlwZVBhdGgsIGJpbmFyeVBhdGgsIGFyZ3MpXG4gICAgICAgIF0pO1xuXG4gICAgICAgIGNvbnN0IGV4aXRDb2RlTWF0Y2ggPSBkYXRhLm1hdGNoKEVYSVRfQ09ERV9SRUdFWFApO1xuXG4gICAgICAgIGlmICghZXhpdENvZGVNYXRjaClcbiAgICAgICAgICAgIHJldHVybiBkYXRhO1xuXG4gICAgICAgIGNvbnN0IGV4aXRDb2RlID0gTnVtYmVyKGV4aXRDb2RlTWF0Y2hbMV0pO1xuXG4gICAgICAgIGlmIChleGl0Q29kZSlcbiAgICAgICAgICAgIHRocm93IG5ldyBOYXRpdmVCaW5hcnlIYXNGYWlsZWRFcnJvcih7IGJpbmFyeTogYmluYXJ5UGF0aCwgb3V0cHV0OiBkYXRhLCBleGl0Q29kZSB9KTtcblxuICAgICAgICByZXR1cm4gZGF0YTtcbiAgICB9XG4gICAgZmluYWxseSB7XG4gICAgICAgIGF3YWl0IGRlbChwaXBlUGF0aCwgeyBmb3JjZTogdHJ1ZSB9KTtcbiAgICB9XG59XG5cbi8vQVBJXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gZXhlY0ZpbGUgKGZpbGVQYXRoLCBhcmdzKSB7XG4gICAgdHJ5IHtcbiAgICAgICAgaWYgKE9TLm1hYylcbiAgICAgICAgICAgIHJldHVybiBhd2FpdCBydW5XaXRoTWFjQXBwKGZpbGVQYXRoLCBhcmdzKTtcblxuICAgICAgICByZXR1cm4gYXdhaXQgZXhlY0ZpbGVQcm9taXNlKGZpbGVQYXRoLCBhcmdzKTtcbiAgICB9XG4gICAgY2F0Y2ggKGVycikge1xuICAgICAgICBpZiAoZXJyIGluc3RhbmNlb2YgTmF0aXZlQmluYXJ5SGFzRmFpbGVkRXJyb3IpXG4gICAgICAgICAgICB0aHJvdyBlcnI7XG5cbiAgICAgICAgY29uc3QgZXJyb3JDb2RlID0gZXJyLnN0YXR1cyB8fCBlcnIuY29kZTtcblxuICAgICAgICBpZiAoZXJyb3JDb2RlID09PSB2b2lkIDAgfHwgdHlwZW9mIGVycm9yQ29kZSA9PT0gJ3N0cmluZycpXG4gICAgICAgICAgICB0aHJvdyBlcnI7XG5cbiAgICAgICAgdGhyb3cgbmV3IE5hdGl2ZUJpbmFyeUhhc0ZhaWxlZEVycm9yKHsgYmluYXJ5OiBmaWxlUGF0aCwgZXhpdENvZGU6IGVycm9yQ29kZSB9KTtcbiAgICB9XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBleGVjIChjb21tYW5kKSB7XG4gICAgcmV0dXJuIGV4ZWNQcm9taXNlKGNvbW1hbmQsIHsgZW52OiBwcm9jZXNzLmVudiB9KTtcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGV4ZWNQb3dlcnNoZWxsIChjb21tYW5kKSB7XG4gICAgY29uc3Qgd3JhcHBlZENvbW1hbmQgPSBQT1dFUlNIRUxMX0NPTU1BTkRfV1JBUFBFUihjb21tYW5kKTtcblxuICAgIC8vIE5PVEU6IFdlIGhhdmUgdG8gaWdub3JlIHN0ZGluIGR1ZSB0byBhIHByb2JsZW0gd2l0aCBQb3dlclNoZWxsIDIuMFxuICAgIC8vIFNlZSBodHRwczovL3N0YWNrb3ZlcmZsb3cuY29tL2EvOTE1NzE3MC8xMTgxODA2MSBmb3IgZGV0YWlscy5cbiAgICByZXR1cm4gZXhlY2EoUE9XRVJTSEVMTF9CSU5BUlksIFsuLi5QT1dFUlNIRUxMX0FSR1MsIHdyYXBwZWRDb21tYW5kXSwgeyBzdGRpbjogJ2lnbm9yZScgfSk7XG59XG4iXX0=